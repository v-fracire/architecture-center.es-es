---
title: Autenticación en aplicaciones multiinquilino
description: Cómo una aplicación multiinquilino puede autenticar los usuarios desde Azure AD
author: MikeWasson
ms.date: 07/21/2017
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: 58ccf75cd34f8efec17898c85295587da282cf45
ms.sourcegitcommit: e7e0e0282fa93f0063da3b57128ade395a9c1ef9
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 12/05/2018
ms.locfileid: "52902721"
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="b65bb-103">Autenticación con Azure AD y OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="b65bb-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="b65bb-104">[![GitHub](../_images/github.png) Código de ejemplo][sample application]</span><span class="sxs-lookup"><span data-stu-id="b65bb-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="b65bb-105">La aplicación Surveys utiliza el protocolo OpenID Connect (OIDC) para autenticar a los usuarios con Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="b65bb-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="b65bb-106">La aplicación Surveys utiliza ASP.NET Core, que tiene integrado un middleware para OIDC.</span><span class="sxs-lookup"><span data-stu-id="b65bb-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="b65bb-107">En el diagrama siguiente, se muestra lo que ocurre cuando el usuario inicia sesión, a un alto nivel.</span><span class="sxs-lookup"><span data-stu-id="b65bb-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![Flujo de autenticación](./images/auth-flow.png)

1. <span data-ttu-id="b65bb-109">El usuario hace clic en el botón de inicio de sesión en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="b65bb-110">Esta acción se controla mediante un controlador MVC.</span><span class="sxs-lookup"><span data-stu-id="b65bb-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="b65bb-111">El controlador MVC devuelve una acción **ChallengeResult** .</span><span class="sxs-lookup"><span data-stu-id="b65bb-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="b65bb-112">El software intermedio intercepta la acción **ChallengeResult** y crea una respuesta 302, que redirige al usuario a la página de inicio de sesión de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b65bb-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="b65bb-113">El usuario se autentica con Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b65bb-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="b65bb-114">Azure AD envía un token de identificador a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="b65bb-115">El software intermedio valida el token de identificador.</span><span class="sxs-lookup"><span data-stu-id="b65bb-115">The middleware validates the ID token.</span></span> <span data-ttu-id="b65bb-116">En este punto, el usuario está ya autenticado dentro de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="b65bb-117">El software intermedio redirige al usuario a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="b65bb-118">Registro de la aplicación con Azure AD</span><span class="sxs-lookup"><span data-stu-id="b65bb-118">Register the app with Azure AD</span></span>
<span data-ttu-id="b65bb-119">Para habilitar OpenID Connect, el proveedor de SaaS registra la aplicación dentro de su propio inquilino de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b65bb-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="b65bb-120">Para registrar la aplicación, siga los pasos de [Integración de aplicaciones con Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), en la sección [Agregar una aplicación](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span><span class="sxs-lookup"><span data-stu-id="b65bb-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="b65bb-121">Consulte [Run the Surveys application](./run-the-app.md) (Ejecutar la aplicación Surveys) para conocer los pasos específicos de la aplicación Surveys.</span><span class="sxs-lookup"><span data-stu-id="b65bb-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="b65bb-122">Tenga en cuenta lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="b65bb-122">Note the following:</span></span>

- <span data-ttu-id="b65bb-123">En el caso de una aplicación de varios inquilinos, debe configurar explícitamente la opción de varios inquilinos.</span><span class="sxs-lookup"><span data-stu-id="b65bb-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="b65bb-124">Esto permite que otras organizaciones tengan acceso a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-124">This enables other organizations to to access the application.</span></span>

- <span data-ttu-id="b65bb-125">La dirección URL de respuesta es la dirección URL a la que Azure AD enviará las respuestas de OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="b65bb-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="b65bb-126">Cuando se usa ASP.NET Core, es necesario que coincida con la ruta de acceso que configure en el middleware de autenticación (consulte la sección siguiente).</span><span class="sxs-lookup"><span data-stu-id="b65bb-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section),</span></span> 

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="b65bb-127">Configuración del middleware de autenticación</span><span class="sxs-lookup"><span data-stu-id="b65bb-127">Configure the auth middleware</span></span>
<span data-ttu-id="b65bb-128">En esta sección se describe cómo configurar el middleware de autenticación en ASP.NET Core 1.0 para la autenticación multiinquilino con OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="b65bb-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="b65bb-129">En la [clase de inicio](/aspnet/core/fundamentals/startup), agregue el middleware OpenID Connect:</span><span class="sxs-lookup"><span data-stu-id="b65bb-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="b65bb-130">Tenga en cuenta que algunos de los valores se toman de opciones de configuración en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="b65bb-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="b65bb-131">Esto es lo que significan las opciones de middleware:</span><span class="sxs-lookup"><span data-stu-id="b65bb-131">Here's what the middleware options mean:</span></span>

* <span data-ttu-id="b65bb-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-132">**ClientId**.</span></span> <span data-ttu-id="b65bb-133">El identificador de cliente de la aplicación, que obtuvo al registrar la aplicación en Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b65bb-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
* <span data-ttu-id="b65bb-134">**Authority**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-134">**Authority**.</span></span> <span data-ttu-id="b65bb-135">Para una aplicación multiinquilino, establezca esta propiedad en `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="b65bb-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="b65bb-136">Se trata de la dirección URL para el punto de conexión común de Azure AD, que permite a los usuarios de cualquier inquilino de Azure AD iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="b65bb-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="b65bb-137">Para más información sobre el punto de conexión común, consulte [esta entrada de blog](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="b65bb-137">For more information about the common endpoint, see [this blog post](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
* <span data-ttu-id="b65bb-138">En **TokenValidationParameters**, establezca **ValidateIssuer** en false.</span><span class="sxs-lookup"><span data-stu-id="b65bb-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="b65bb-139">Esto significa que la aplicación se encargará de validar el valor del emisor en el token de identificador.</span><span class="sxs-lookup"><span data-stu-id="b65bb-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="b65bb-140">(El middleware sigue validando el token por sí mismo). Para obtener más información acerca de la validación del emisor, consulte [Issuer validation](claims.md#issuer-validation) (Validación de emisor).</span><span class="sxs-lookup"><span data-stu-id="b65bb-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
* <span data-ttu-id="b65bb-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="b65bb-142">Especifique una dirección URL a la que redirigir a los usuarios tras el cierre de sesión. Debe tratarse de una página que permita las solicitudes anónimas, normalmente la página principal.</span><span class="sxs-lookup"><span data-stu-id="b65bb-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
* <span data-ttu-id="b65bb-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-143">**SignInScheme**.</span></span> <span data-ttu-id="b65bb-144">Establezca esta opción en `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="b65bb-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="b65bb-145">Esta configuración significa que, después de autenticarse el usuario, las notificaciones de usuario se almacenan localmente en una cookie.</span><span class="sxs-lookup"><span data-stu-id="b65bb-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="b65bb-146">Esta cookie es la forma en que la sesión del usuario permanece iniciada durante la sesión del explorador.</span><span class="sxs-lookup"><span data-stu-id="b65bb-146">This cookie is how the user stays logged in during the browser session.</span></span>
* <span data-ttu-id="b65bb-147">**Eventos.**</span><span class="sxs-lookup"><span data-stu-id="b65bb-147">**Events.**</span></span> <span data-ttu-id="b65bb-148">Devoluciones de llamada de evento; consulte [Eventos de autenticación](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="b65bb-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="b65bb-149">Además, agregue el software intermedio de autenticación de cookies a la canalización.</span><span class="sxs-lookup"><span data-stu-id="b65bb-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="b65bb-150">Este software intermedio se encarga de escribir las notificaciones del usuario en una cookie y después de leerla durante las cargas de página posteriores.</span><span class="sxs-lookup"><span data-stu-id="b65bb-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="b65bb-151">Inicio del flujo de autenticación</span><span class="sxs-lookup"><span data-stu-id="b65bb-151">Initiate the authentication flow</span></span>
<span data-ttu-id="b65bb-152">Para iniciar el flujo de autenticación en el MVC de ASP.NET, devuelva una acción **ChallengeResult** desde el controlador:</span><span class="sxs-lookup"><span data-stu-id="b65bb-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="b65bb-153">Esto hace que el software intermedio devuelva una respuesta 302 (encontrado) que redirige al punto de conexión de autenticación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="b65bb-154">Sesiones de inicio de sesión de usuario</span><span class="sxs-lookup"><span data-stu-id="b65bb-154">User login sessions</span></span>
<span data-ttu-id="b65bb-155">Como se ha mencionado, cuando el usuario inicia sesión por primera vez, el software intermedio de autenticación de cookies escribe las notificaciones del usuario en una cookie.</span><span class="sxs-lookup"><span data-stu-id="b65bb-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="b65bb-156">Después, se autentican las solicitudes HTTP al leer la cookie.</span><span class="sxs-lookup"><span data-stu-id="b65bb-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="b65bb-157">De forma predeterminada, el middleware de cookies escribe una [cookie de sesión][session-cookie], que se elimina una vez que el usuario cierra el explorador.</span><span class="sxs-lookup"><span data-stu-id="b65bb-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="b65bb-158">La próxima vez que el usuario visita el sitio, tendrá que iniciar sesión de nuevo.</span><span class="sxs-lookup"><span data-stu-id="b65bb-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="b65bb-159">Sin embargo, si establece **IsPersistent** en true en **ChallengeResult**, el middleware escribe una cookie persistente, por lo que la sesión del usuario permanece abierta después de cerrar el explorador.</span><span class="sxs-lookup"><span data-stu-id="b65bb-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="b65bb-160">Puede configurar la expiración de las cookies; consulte [Controlar opciones de cookie][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="b65bb-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="b65bb-161">Las cookies persistentes son más cómodas para el usuario, pero pueden ser inadecuadas para algunas aplicaciones (por ejemplo, una aplicación de banca) en las que el usuario desea iniciar sesión cada vez.</span><span class="sxs-lookup"><span data-stu-id="b65bb-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="b65bb-162">Acerca del software intermedio OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="b65bb-162">About the OpenID Connect middleware</span></span>
<span data-ttu-id="b65bb-163">El software intermedio OpenID Connect en ASP.NET oculta la mayoría de los detalles del protocolo.</span><span class="sxs-lookup"><span data-stu-id="b65bb-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="b65bb-164">Esta sección contiene algunas notas sobre la implementación que pueden ser útiles para comprender el flujo del protocolo.</span><span class="sxs-lookup"><span data-stu-id="b65bb-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="b65bb-165">En primer lugar, vamos a examinar el flujo de autenticación en términos de ASP.NET (omitiendo los detalles del flujo de protocolo OIDC entre la aplicación y Azure AD).</span><span class="sxs-lookup"><span data-stu-id="b65bb-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="b65bb-166">En el siguiente diagrama se muestra el proceso.</span><span class="sxs-lookup"><span data-stu-id="b65bb-166">The following diagram shows the process.</span></span>

![Flujo de inicio de sesión](./images/sign-in-flow.png)

<span data-ttu-id="b65bb-168">En este diagrama, hay dos controladores MVC.</span><span class="sxs-lookup"><span data-stu-id="b65bb-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="b65bb-169">El controlador de cuentas controla las solicitudes de inicio de sesión y el controlador principal sirve la página principal.</span><span class="sxs-lookup"><span data-stu-id="b65bb-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="b65bb-170">Este es el proceso de autenticación:</span><span class="sxs-lookup"><span data-stu-id="b65bb-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="b65bb-171">El usuario hace clic en el botón de inicio de sesión y el explorador envía una solicitud GET.</span><span class="sxs-lookup"><span data-stu-id="b65bb-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="b65bb-172">Por ejemplo: `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="b65bb-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="b65bb-173">El controlador de cuentas devuelve una acción `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="b65bb-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="b65bb-174">El software intermedio OIDC devuelve una respuesta HTTP 302 y redirige al usuario a Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b65bb-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="b65bb-175">El explorador envía la solicitud de autenticación a Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b65bb-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="b65bb-176">El usuario inicia sesión en Azure AD, desde donde se devuelve una respuesta de autenticación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="b65bb-177">El software intermedio OIDC crea una entidad de seguridad de notificaciones y la pasa al software intermedio de autenticación de cookies.</span><span class="sxs-lookup"><span data-stu-id="b65bb-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="b65bb-178">El software intermedio de cookies serializa la entidad de seguridad de notificaciones y establece una cookie.</span><span class="sxs-lookup"><span data-stu-id="b65bb-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="b65bb-179">El software intermedio OIDC redirige a la dirección URL de devolución de llamada de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="b65bb-180">El explorador sigue a la redirección y envía la cookie en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="b65bb-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="b65bb-181">El software intermedio de cookies deserializa la cookie en una entidad de seguridad de notificaciones y establece `HttpContext.User` en dicha entidad.</span><span class="sxs-lookup"><span data-stu-id="b65bb-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="b65bb-182">La solicitud se enruta a un controlador MVC.</span><span class="sxs-lookup"><span data-stu-id="b65bb-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="b65bb-183">Vale de autenticación</span><span class="sxs-lookup"><span data-stu-id="b65bb-183">Authentication ticket</span></span>
<span data-ttu-id="b65bb-184">Si la autenticación se realiza correctamente, el software intermedio OIDC crea un vale de autenticación, que contiene una entidad de seguridad de notificaciones con las notificaciones del usuario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="b65bb-185">Puede tener acceso al vale en **AuthenticationValidated** o el evento **TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="b65bb-186">Hasta que se complete el flujo de autenticación en su totalidad, `HttpContext.User` sigue albergando una entidad de seguridad anónima, **no** el usuario autenticado.</span><span class="sxs-lookup"><span data-stu-id="b65bb-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="b65bb-187">La entidad de seguridad anónima tiene una colección vacía de notificaciones.</span><span class="sxs-lookup"><span data-stu-id="b65bb-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="b65bb-188">Una vez que la autenticación se completa y la aplicación realiza la redirección, el software intermedio de cookies deserializa la cookie de autenticación y establece `HttpContext.User` en una entidad de seguridad de notificaciones que representa al usuario autenticado.</span><span class="sxs-lookup"><span data-stu-id="b65bb-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>
> 
> 

### <a name="authentication-events"></a><span data-ttu-id="b65bb-189">Eventos de autenticación</span><span class="sxs-lookup"><span data-stu-id="b65bb-189">Authentication events</span></span>
<span data-ttu-id="b65bb-190">Durante el proceso de autenticación, el software intermedio OpenID Connect genera una serie de eventos:</span><span class="sxs-lookup"><span data-stu-id="b65bb-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

* <span data-ttu-id="b65bb-191">**RedirectToIdentityProvider**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="b65bb-192">Se llama justo antes de que el software intermedio redirija al punto de conexión de autenticación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="b65bb-193">Puede usar este evento para modificar la dirección URL de redireccionamiento; por ejemplo, para agregar parámetros de solicitud.</span><span class="sxs-lookup"><span data-stu-id="b65bb-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="b65bb-194">Consulte [Incorporación de la petición de consentimiento del administrador](signup.md#adding-the-admin-consent-prompt) para ver un ejemplo.</span><span class="sxs-lookup"><span data-stu-id="b65bb-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
* <span data-ttu-id="b65bb-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="b65bb-196">Se llama con el código de autorización.</span><span class="sxs-lookup"><span data-stu-id="b65bb-196">Called with the authorization code.</span></span>
* <span data-ttu-id="b65bb-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="b65bb-198">Se llama después de que el software intermedio obtiene un token de acceso desde el IDP, pero antes de que se valide.</span><span class="sxs-lookup"><span data-stu-id="b65bb-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="b65bb-199">Se aplica solo al flujo de código de autorización.</span><span class="sxs-lookup"><span data-stu-id="b65bb-199">Applies only to authorization code flow.</span></span>
* <span data-ttu-id="b65bb-200">**TokenValidated**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-200">**TokenValidated**.</span></span> <span data-ttu-id="b65bb-201">Se llama después de que el software intermedio valide el token de identificador.</span><span class="sxs-lookup"><span data-stu-id="b65bb-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="b65bb-202">En este punto, la aplicación tiene un conjunto de notificaciones validadas sobre el usuario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="b65bb-203">Puede usar este evento para realizar una validación adicional de las notificaciones o para transformarlas.</span><span class="sxs-lookup"><span data-stu-id="b65bb-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="b65bb-204">Consulte [Working with claims-based identities in multitenant applications](claims.md)(Trabajo con identidades basadas en notificaciones en aplicaciones multiinquilino)</span><span class="sxs-lookup"><span data-stu-id="b65bb-204">See [Working with claims](claims.md).</span></span>
* <span data-ttu-id="b65bb-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-205">**UserInformationReceived**.</span></span> <span data-ttu-id="b65bb-206">Se llama si el software intermedio obtiene el perfil de usuario desde el punto de conexión de información de usuario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="b65bb-207">Solo se aplica al flujo de código de autorización y solamente con `GetClaimsFromUserInfoEndpoint = true` en las opciones del software intermedio.</span><span class="sxs-lookup"><span data-stu-id="b65bb-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
* <span data-ttu-id="b65bb-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-208">**TicketReceived**.</span></span> <span data-ttu-id="b65bb-209">Se llama cuando se completa la autenticación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-209">Called when authentication is completed.</span></span> <span data-ttu-id="b65bb-210">Se trata del último evento, siempre que la autenticación se realice correctamente.</span><span class="sxs-lookup"><span data-stu-id="b65bb-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="b65bb-211">Una vez que se controla este evento, el usuario inicia sesión en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-211">After this event is handled, the user is signed into the app.</span></span>
* <span data-ttu-id="b65bb-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="b65bb-213">Se llama si se produce un error de autenticación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-213">Called if authentication fails.</span></span> <span data-ttu-id="b65bb-214">Use este evento para controlar los errores de autenticación; por ejemplo, redirigiendo a una página de error.</span><span class="sxs-lookup"><span data-stu-id="b65bb-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="b65bb-215">Para proporcionar devoluciones de llamada para estos eventos, establezca la opción **Events** en el software intermedio.</span><span class="sxs-lookup"><span data-stu-id="b65bb-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="b65bb-216">Hay dos maneras diferentes de declarar los controladores de eventos: insertados con expresiones lambda o en una clase que deriva de **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="b65bb-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="b65bb-217">Se recomienda el segundo enfoque si sus devoluciones de llamada de evento tienen lógica sustancial, para que no sobrecarguen la clase de inicio.</span><span class="sxs-lookup"><span data-stu-id="b65bb-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="b65bb-218">Nuestra implementación de referencia usa este enfoque.</span><span class="sxs-lookup"><span data-stu-id="b65bb-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="b65bb-219">Puntos de conexión de OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="b65bb-219">OpenID connect endpoints</span></span>
<span data-ttu-id="b65bb-220">Azure AD admite [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), donde un proveedor de identidades devuelve un documento de metadatos de JSON desde un [punto de conexión conocido](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="b65bb-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="b65bb-221">El documento de metadatos contiene información como:</span><span class="sxs-lookup"><span data-stu-id="b65bb-221">The metadata document contains information such as:</span></span>

* <span data-ttu-id="b65bb-222">La dirección URL del punto de conexión de autorización.</span><span class="sxs-lookup"><span data-stu-id="b65bb-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="b65bb-223">Aquí es a donde redirige la aplicación para autenticar al usuario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-223">This is where the app redirects to authenticate the user.</span></span>
* <span data-ttu-id="b65bb-224">La dirección URL del punto de conexión de fin de sesión, a donde la aplicación va para cerrar la sesión del usuario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
* <span data-ttu-id="b65bb-225">La dirección URL para obtener las claves de firma, que el cliente usa para validar los tokens de OIDC que obtiene del IDP.</span><span class="sxs-lookup"><span data-stu-id="b65bb-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="b65bb-226">De forma predeterminada, el software intermedio OIDC sabe cómo capturar estos metadatos.</span><span class="sxs-lookup"><span data-stu-id="b65bb-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="b65bb-227">Establezca la opción **Authority** en el software intermedio, el cual construye la dirección URL para los metadatos.</span><span class="sxs-lookup"><span data-stu-id="b65bb-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="b65bb-228">(La dirección URL de metadatos se puede invalidar estableciendo la opción **MetadataAddress** ).</span><span class="sxs-lookup"><span data-stu-id="b65bb-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="b65bb-229">Flujos de OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="b65bb-229">OpenID connect flows</span></span>
<span data-ttu-id="b65bb-230">De forma predeterminada, el software intermedio OIDC usa un flujo híbrido con el modo de respuesta de envío de formulario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

* <span data-ttu-id="b65bb-231">*Flujo híbrido* significa que el cliente puede obtener un token de identificador y un código de autorización en el mismo recorrido de ida y vuelta al servidor de autorización.</span><span class="sxs-lookup"><span data-stu-id="b65bb-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
* <span data-ttu-id="b65bb-232">*Modo de respuesta de envío de formulario* significa que el servidor de autorización usa una solicitud POST HTTP para enviar el token de identificador y el código autorización a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b65bb-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="b65bb-233">Los valores tienen el formato form-urlencoded (content type = "application/x-www-form-urlencoded").</span><span class="sxs-lookup"><span data-stu-id="b65bb-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="b65bb-234">Cuando el software intermedio OIDC redirige al punto de conexión de autorización, la dirección URL de redireccionamiento incluye todos los parámetros de cadena de consulta necesarios para OIDC.</span><span class="sxs-lookup"><span data-stu-id="b65bb-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="b65bb-235">Para el flujo híbrido:</span><span class="sxs-lookup"><span data-stu-id="b65bb-235">For hybrid flow:</span></span>

* <span data-ttu-id="b65bb-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="b65bb-236">client_id.</span></span> <span data-ttu-id="b65bb-237">Este valor se establece en la opción **ClientId** .</span><span class="sxs-lookup"><span data-stu-id="b65bb-237">This value is set in the **ClientId** option</span></span>
* <span data-ttu-id="b65bb-238">scope = "openid profile", lo que significa que es una solicitud de OIDC y que se busca el perfil del usuario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
* <span data-ttu-id="b65bb-239">response_type  = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="b65bb-239">response_type  = "code id_token".</span></span> <span data-ttu-id="b65bb-240">Esto especifica el flujo híbrido.</span><span class="sxs-lookup"><span data-stu-id="b65bb-240">This specifies hybrid flow.</span></span>
* <span data-ttu-id="b65bb-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="b65bb-241">response_mode = "form_post".</span></span> <span data-ttu-id="b65bb-242">Esto especifica la respuesta de envío de formulario.</span><span class="sxs-lookup"><span data-stu-id="b65bb-242">This specifies form post response.</span></span>

<span data-ttu-id="b65bb-243">Para especificar un flujo diferente, establezca la propiedad **ResponseType** en las opciones.</span><span class="sxs-lookup"><span data-stu-id="b65bb-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="b65bb-244">Por ejemplo: </span><span class="sxs-lookup"><span data-stu-id="b65bb-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="b65bb-245">[**Siguiente**][claims]</span><span class="sxs-lookup"><span data-stu-id="b65bb-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
