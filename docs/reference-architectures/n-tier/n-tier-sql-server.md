---
title: Aplicación de n niveles con SQL Server
description: Implementación de una arquitectura de varios niveles en Azure para lograr una mayor disponibilidad, seguridad, escalabilidad y facilidad de uso.
author: MikeWasson
ms.date: 06/23/2018
ms.openlocfilehash: 050ea9b3104a2dc9af4cdaad3b4540cd75434e9d
ms.sourcegitcommit: 767c8570d7ab85551c2686c095b39a56d813664b
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 06/24/2018
ms.locfileid: "36746679"
---
# <a name="n-tier-application-with-sql-server"></a><span data-ttu-id="ba482-103">Aplicación de n niveles con SQL Server</span><span class="sxs-lookup"><span data-stu-id="ba482-103">N-tier application with SQL Server</span></span>

<span data-ttu-id="ba482-104">Esta arquitectura de referencia muestra cómo implementar máquinas virtuales y una red virtual configurada para una aplicación de n niveles, con SQL Server en Windows para la capa de datos.</span><span class="sxs-lookup"><span data-stu-id="ba482-104">This reference architecture shows how to deploy VMs and a virtual network configured for an N-tier application, using SQL Server on Windows for the data tier.</span></span> [<span data-ttu-id="ba482-105">**Implemente esta solución**.</span><span class="sxs-lookup"><span data-stu-id="ba482-105">**Deploy this solution**.</span></span>](#deploy-the-solution) 

<span data-ttu-id="ba482-106">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="ba482-106">![[0]][0]</span></span>

<span data-ttu-id="ba482-107">*Descargue un [archivo Visio][visio-download] de esta arquitectura.*</span><span class="sxs-lookup"><span data-stu-id="ba482-107">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="ba482-108">Architecture</span><span class="sxs-lookup"><span data-stu-id="ba482-108">Architecture</span></span> 

<span data-ttu-id="ba482-109">La arquitectura consta de los siguientes componentes:</span><span class="sxs-lookup"><span data-stu-id="ba482-109">The architecture has the following components:</span></span>

* <span data-ttu-id="ba482-110">**Grupo de recursos.**</span><span class="sxs-lookup"><span data-stu-id="ba482-110">**Resource group.**</span></span> <span data-ttu-id="ba482-111">Los [grupos de recursos][resource-manager-overview] se utilizan para agrupar los recursos, para que puedan administrarse según su duración, su propietario u otros criterios.</span><span class="sxs-lookup"><span data-stu-id="ba482-111">[Resource groups][resource-manager-overview] are used to group resources so they can be managed by lifetime, owner, or other criteria.</span></span>

* <span data-ttu-id="ba482-112">**Red virtual y subredes.**</span><span class="sxs-lookup"><span data-stu-id="ba482-112">**Virtual network (VNet) and subnets.**</span></span> <span data-ttu-id="ba482-113">Cada máquina virtual de Azure se implementa en una red virtual que se puede dividir en varias subredes.</span><span class="sxs-lookup"><span data-stu-id="ba482-113">Every Azure VM is deployed into a VNet that can be segmented into multiple subnets.</span></span> <span data-ttu-id="ba482-114">Cree una subred independiente para cada nivel.</span><span class="sxs-lookup"><span data-stu-id="ba482-114">Create a separate subnet for each tier.</span></span> 

* <span data-ttu-id="ba482-115">**Grupos de seguridad de red.**</span><span class="sxs-lookup"><span data-stu-id="ba482-115">**NSGs.**</span></span> <span data-ttu-id="ba482-116">Use [grupos de seguridad de red][nsg] (NSG) para restringir el tráfico de red dentro de la red virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-116">Use [network security groups][nsg] (NSGs) to restrict network traffic within the VNet.</span></span> <span data-ttu-id="ba482-117">Por ejemplo, en la arquitectura de tres niveles que se muestra aquí, el nivel de base de datos no acepta el tráfico desde el front-end web, solo desde el nivel Business y la subred de administración.</span><span class="sxs-lookup"><span data-stu-id="ba482-117">For example, in the 3-tier architecture shown here, the database tier does not accept traffic from the web front end, only from the business tier and the management subnet.</span></span>

* <span data-ttu-id="ba482-118">**Máquinas virtuales**.</span><span class="sxs-lookup"><span data-stu-id="ba482-118">**Virtual machines**.</span></span> <span data-ttu-id="ba482-119">Para obtener recomendaciones sobre la configuración de máquinas virtuales, consulte [Ejecución de una VM con Windows en Azure](./windows-vm.md) y [Ejecución de una VM con Linux en Azure](./linux-vm.md).</span><span class="sxs-lookup"><span data-stu-id="ba482-119">For recommendations on configuring VMs, see [Run a Windows VM on Azure](./windows-vm.md) and [Run a Linux VM on Azure](./linux-vm.md).</span></span>

* <span data-ttu-id="ba482-120">**Conjuntos de disponibilidad**.</span><span class="sxs-lookup"><span data-stu-id="ba482-120">**Availability sets.**</span></span> <span data-ttu-id="ba482-121">Cree un [conjunto de disponibilidad][azure-availability-sets] para cada nivel y aprovisione al menos dos máquinas virtuales en cada nivel.</span><span class="sxs-lookup"><span data-stu-id="ba482-121">Create an [availability set][azure-availability-sets] for each tier, and provision at least two VMs in each tier.</span></span> <span data-ttu-id="ba482-122">Esto hace que las máquinas virtuales sean aptas para un [Acuerdo de Nivel de Servicio (SLA)][vm-sla] mayor.</span><span class="sxs-lookup"><span data-stu-id="ba482-122">This makes the VMs eligible for a higher [service level agreement (SLA)][vm-sla] for VMs.</span></span> 

* <span data-ttu-id="ba482-123">**Conjunto de escalado de máquinas virtuales** (no se muestra).</span><span class="sxs-lookup"><span data-stu-id="ba482-123">**VM scale set** (not shown).</span></span> <span data-ttu-id="ba482-124">Un [conjunto de escalado de máquinas virtuales][vmss] es una alternativa al uso de un conjunto de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="ba482-124">A [VM scale set][vmss] is an alternative to using an availability set.</span></span> <span data-ttu-id="ba482-125">Los conjuntos de escalado facilitan el escalado horizontal de las máquinas virtuales de un nivel, de forma manual o automática, y según reglas predefinidas.</span><span class="sxs-lookup"><span data-stu-id="ba482-125">A scale sets makes it easy to scale out the VMs in a tier, either manually or automatically based on predefined rules.</span></span>

* <span data-ttu-id="ba482-126">**Equilibradores de carga de Azure.**</span><span class="sxs-lookup"><span data-stu-id="ba482-126">**Azure Load balancers.**</span></span> <span data-ttu-id="ba482-127">Los [equilibradores de carga][load-balancer] distribuyen las solicitudes entrantes de Internet a las instancias de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-127">The [load balancers][load-balancer] distribute incoming Internet requests to the VM instances.</span></span> <span data-ttu-id="ba482-128">Use un [equilibrador de carga público][load-balancer-external] para distribuir el tráfico entrante de Internet al nivel Web y un [equilibrador de carga interno][load-balancer-internal] para distribuir el tráfico de red del nivel Web al nivel Business.</span><span class="sxs-lookup"><span data-stu-id="ba482-128">Use a [public load balancer][load-balancer-external] to distribute incoming Internet traffic to the web tier, and an [internal load balancer][load-balancer-internal] to distribute network traffic from the web tier to the business tier.</span></span>

* <span data-ttu-id="ba482-129">**Dirección IP pública**.</span><span class="sxs-lookup"><span data-stu-id="ba482-129">**Public IP address**.</span></span> <span data-ttu-id="ba482-130">Se necesita una dirección IP pública para que el equilibrador de carga reciba tráfico de Internet.</span><span class="sxs-lookup"><span data-stu-id="ba482-130">A public IP address is needed for the public load balancer to receive Internet traffic.</span></span>

* <span data-ttu-id="ba482-131">**JumpBox.**</span><span class="sxs-lookup"><span data-stu-id="ba482-131">**Jumpbox.**</span></span> <span data-ttu-id="ba482-132">También se denomina [host bastión].</span><span class="sxs-lookup"><span data-stu-id="ba482-132">Also called a [bastion host].</span></span> <span data-ttu-id="ba482-133">Se trata de una máquina virtual segura en la red que usan los administradores para conectarse al resto de máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="ba482-133">A secure VM on the network that administrators use to connect to the other VMs.</span></span> <span data-ttu-id="ba482-134">El Jumpbox tiene un NSG que solo permite el tráfico remoto que procede de direcciones IP públicas de una lista segura.</span><span class="sxs-lookup"><span data-stu-id="ba482-134">The jumpbox has an NSG that allows remote traffic only from public IP addresses on a safe list.</span></span> <span data-ttu-id="ba482-135">El NSG debe permitir el tráfico de escritorio remoto (RDP).</span><span class="sxs-lookup"><span data-stu-id="ba482-135">The NSG should permit remote desktop (RDP) traffic.</span></span>

* <span data-ttu-id="ba482-136">**Grupo de disponibilidad AlwaysOn de SQL Server**.</span><span class="sxs-lookup"><span data-stu-id="ba482-136">**SQL Server Always On Availability Group.**</span></span> <span data-ttu-id="ba482-137">Proporciona alta disponibilidad en el nivel de datos, al habilitar la replicación y la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="ba482-137">Provides high availability at the data tier, by enabling replication and failover.</span></span> <span data-ttu-id="ba482-138">Usa la tecnología de clúster de conmutación por error de Windows Server (WSFC) para la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="ba482-138">It uses Windows Server Failover Cluster (WSFC) technology for failover.</span></span>

* <span data-ttu-id="ba482-139">**Servidores de Active Directory Domain Services (AD DS)**.</span><span class="sxs-lookup"><span data-stu-id="ba482-139">**Active Directory Domain Services (AD DS) Servers**.</span></span> <span data-ttu-id="ba482-140">Los objetos de equipo del clúster de conmutación por error y sus roles en clúster asociados se crean en Active Directory Domain Services (AD DS).</span><span class="sxs-lookup"><span data-stu-id="ba482-140">The computer objects for the failover cluster and its associated clustered roles are created in Active Directory Domain Services (AD DS).</span></span>

* <span data-ttu-id="ba482-141">**Testigo en la nube**.</span><span class="sxs-lookup"><span data-stu-id="ba482-141">**Cloud Witness**.</span></span> <span data-ttu-id="ba482-142">Un clúster de conmutación por error requiere que más de la mitad de sus nodos se estén ejecutando, lo que se conoce como tener cuórum.</span><span class="sxs-lookup"><span data-stu-id="ba482-142">A failover cluster requires more than half of its nodes to be running, which is known as having quorum.</span></span> <span data-ttu-id="ba482-143">Si el clúster tiene solo dos nodos, una partición de la red podría provocar que cada uno de ellos creyera que es el principal.</span><span class="sxs-lookup"><span data-stu-id="ba482-143">If the cluster has just two nodes, a network partition could cause each node to think it's the master node.</span></span> <span data-ttu-id="ba482-144">En ese caso, se necesita un *testigo* que sea quien dilucide cuál es el principal y establezca el cuórum.</span><span class="sxs-lookup"><span data-stu-id="ba482-144">In that case, you need a *witness* to break ties and establish quorum.</span></span> <span data-ttu-id="ba482-145">Un testigo es un recurso, como por ejemplo un disco compartido, que puede actuar como dilucidador para establecer el cuórum.</span><span class="sxs-lookup"><span data-stu-id="ba482-145">A witness is a resource such as a shared disk that can act as a tie breaker to establish quorum.</span></span> <span data-ttu-id="ba482-146">Un testigo en la nube es un tipo de testigo que usa Azure Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="ba482-146">Cloud Witness is a type of witness that uses Azure Blob Storage.</span></span> <span data-ttu-id="ba482-147">Para más información acerca del concepto de quórum, consulte [Understanding cluster and pool quorum](/windows-server/storage/storage-spaces/understand-quorum) (Descripción del cuórum de clúster y de grupo).</span><span class="sxs-lookup"><span data-stu-id="ba482-147">To learn more about the concept of quorum, see [Understanding cluster and pool quorum](/windows-server/storage/storage-spaces/understand-quorum).</span></span> <span data-ttu-id="ba482-148">Para más información acerca del testigo en la nube, consulte [Implementación de un testigo en la nube en un clúster de conmutación por error](/windows-server/failover-clustering/deploy-cloud-witness).</span><span class="sxs-lookup"><span data-stu-id="ba482-148">For more information about Cloud Witness, see [Deploy a Cloud Witness for a Failover Cluster](/windows-server/failover-clustering/deploy-cloud-witness).</span></span> 

* <span data-ttu-id="ba482-149">**Azure DNS**.</span><span class="sxs-lookup"><span data-stu-id="ba482-149">**Azure DNS**.</span></span> <span data-ttu-id="ba482-150">[Azure DNS][azure-dns] es un servicio de hospedaje para dominios DNS que permite resolver nombres mediante la infraestructura de Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="ba482-150">[Azure DNS][azure-dns] is a hosting service for DNS domains, providing name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="ba482-151">Al hospedar dominios en Azure, puede administrar los registros DNS con las mismas credenciales, API, herramientas y facturación que con los demás servicios de Azure.</span><span class="sxs-lookup"><span data-stu-id="ba482-151">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>

## <a name="recommendations"></a><span data-ttu-id="ba482-152">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="ba482-152">Recommendations</span></span>

<span data-ttu-id="ba482-153">Los requisitos pueden diferir de los de la arquitectura que se describe aquí.</span><span class="sxs-lookup"><span data-stu-id="ba482-153">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="ba482-154">Use estas recomendaciones como punto inicial.</span><span class="sxs-lookup"><span data-stu-id="ba482-154">Use these recommendations as a starting point.</span></span> 

### <a name="vnet--subnets"></a><span data-ttu-id="ba482-155">Red virtual/subredes</span><span class="sxs-lookup"><span data-stu-id="ba482-155">VNet / Subnets</span></span>

<span data-ttu-id="ba482-156">Cuando cree la red virtual, determine cuántas direcciones IP requieren los recursos de cada subred.</span><span class="sxs-lookup"><span data-stu-id="ba482-156">When you create the VNet, determine how many IP addresses your resources in each subnet require.</span></span> <span data-ttu-id="ba482-157">Especifique una máscara de subred y un intervalo de direcciones de la red virtual lo suficientemente grande para la dirección IP requerida con el uso de la notación [CIDR].</span><span class="sxs-lookup"><span data-stu-id="ba482-157">Specify a subnet mask and a VNet address range large enough for the required IP addresses, using [CIDR] notation.</span></span> <span data-ttu-id="ba482-158">Use un espacio de direcciones que se encuentre dentro de los [bloques de direcciones IP privados][private-ip-space] estándar, que son 10.0.0.0/8, 172.16.0.0/12 y 192.168.0.0/16.</span><span class="sxs-lookup"><span data-stu-id="ba482-158">Use an address space that falls within the standard [private IP address blocks][private-ip-space], which are 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16.</span></span>

<span data-ttu-id="ba482-159">Elija un intervalo de direcciones que no se superponga con la red local, en caso de que necesite configurar una puerta de enlace entre la red virtual y la red local más adelante.</span><span class="sxs-lookup"><span data-stu-id="ba482-159">Choose an address range that does not overlap with your on-premises network, in case you need to set up a gateway between the VNet and your on-premise network later.</span></span> <span data-ttu-id="ba482-160">Una vez creada la red virtual, no se puede cambiar el intervalo de direcciones.</span><span class="sxs-lookup"><span data-stu-id="ba482-160">Once you create the VNet, you can't change the address range.</span></span>

<span data-ttu-id="ba482-161">Diseñe subredes teniendo en cuenta los requisitos de funcionalidad y seguridad.</span><span class="sxs-lookup"><span data-stu-id="ba482-161">Design subnets with functionality and security requirements in mind.</span></span> <span data-ttu-id="ba482-162">Todas las máquinas virtuales dentro del mismo nivel o rol deben incluirse en la misma subred, lo que puede servir como un límite de seguridad.</span><span class="sxs-lookup"><span data-stu-id="ba482-162">All VMs within the same tier or role should go into the same subnet, which can be a security boundary.</span></span> <span data-ttu-id="ba482-163">Para obtener más información sobre el diseño de redes virtuales y subredes, vea [Planeación y diseño de redes virtuales de Azure][plan-network].</span><span class="sxs-lookup"><span data-stu-id="ba482-163">For more information about designing VNets and subnets, see [Plan and design Azure Virtual Networks][plan-network].</span></span>

### <a name="load-balancers"></a><span data-ttu-id="ba482-164">Equilibradores de carga</span><span class="sxs-lookup"><span data-stu-id="ba482-164">Load balancers</span></span>

<span data-ttu-id="ba482-165">No exponga las máquinas virtuales directamente a Internet; en su lugar, asigne una dirección IP privada a cada máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-165">Do not expose the VMs directly to the Internet, but instead give each VM a private IP address.</span></span> <span data-ttu-id="ba482-166">Los clientes se conectan con la dirección IP del equilibrador de carga público.</span><span class="sxs-lookup"><span data-stu-id="ba482-166">Clients connect using the IP address of the public load balancer.</span></span>

<span data-ttu-id="ba482-167">Defina reglas del equilibrador de carga para dirigir el tráfico de red a las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="ba482-167">Define load balancer rules to direct network traffic to the VMs.</span></span> <span data-ttu-id="ba482-168">Por ejemplo, para habilitar el tráfico HTTP, cree una regla que asigne el puerto 80 de la configuración de front-end al puerto 80 del grupo de direcciones de back-end.</span><span class="sxs-lookup"><span data-stu-id="ba482-168">For example, to enable HTTP traffic, create a rule that maps port 80 from the front-end configuration to port 80 on the back-end address pool.</span></span> <span data-ttu-id="ba482-169">Cuando un cliente envía una solicitud HTTP al puerto 80, el equilibrador de carga selecciona una dirección IP de back-end mediante un [algoritmo hash][load-balancer-hashing] que incluye la dirección IP de origen.</span><span class="sxs-lookup"><span data-stu-id="ba482-169">When a client sends an HTTP request to port 80, the load balancer selects a back-end IP address by using a [hashing algorithm][load-balancer-hashing] that includes the source IP address.</span></span> <span data-ttu-id="ba482-170">De ese modo, las solicitudes de cliente se distribuyen entre todas las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="ba482-170">In that way, client requests are distributed across all the VMs.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="ba482-171">Grupos de seguridad de red</span><span class="sxs-lookup"><span data-stu-id="ba482-171">Network security groups</span></span>

<span data-ttu-id="ba482-172">Use reglas NSG para restringir el tráfico entre los niveles.</span><span class="sxs-lookup"><span data-stu-id="ba482-172">Use NSG rules to restrict traffic between tiers.</span></span> <span data-ttu-id="ba482-173">Por ejemplo, en la arquitectura de tres niveles mostrada anteriormente, el nivel Web no se comunica directamente con el nivel de base de datos.</span><span class="sxs-lookup"><span data-stu-id="ba482-173">For example, in the 3-tier architecture shown above, the web tier does not communicate directly with the database tier.</span></span> <span data-ttu-id="ba482-174">Para exigir esto, el nivel de base de datos debe bloquear el tráfico entrante desde la subred del nivel Web.</span><span class="sxs-lookup"><span data-stu-id="ba482-174">To enforce this, the database tier should block incoming traffic from the web tier subnet.</span></span>  

1. <span data-ttu-id="ba482-175">Deniegue todo el tráfico entrante de la red virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-175">Deny all inbound traffic from the VNet.</span></span> <span data-ttu-id="ba482-176">(Use la etiqueta `VIRTUAL_NETWORK` de la regla).</span><span class="sxs-lookup"><span data-stu-id="ba482-176">(Use the `VIRTUAL_NETWORK` tag in the rule.)</span></span> 
2. <span data-ttu-id="ba482-177">Permita el tráfico entrante de la subred del nivel Business.</span><span class="sxs-lookup"><span data-stu-id="ba482-177">Allow inbound traffic from the business tier subnet.</span></span>  
3. <span data-ttu-id="ba482-178">Permita el tráfico entrante de la propia subred del nivel de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ba482-178">Allow inbound traffic from the database tier subnet itself.</span></span> <span data-ttu-id="ba482-179">Esta regla permite la comunicación entre las máquinas virtuales de la base de datos, lo cual es necesario para la replicación y la conmutación por error de esta.</span><span class="sxs-lookup"><span data-stu-id="ba482-179">This rule allows communication between the database VMs, which is needed for database replication and failover.</span></span>
4. <span data-ttu-id="ba482-180">Permita el tráfico RDP (puerto 3389) desde la subred de JumpBox.</span><span class="sxs-lookup"><span data-stu-id="ba482-180">Allow RDP traffic (port 3389) from the jumpbox subnet.</span></span> <span data-ttu-id="ba482-181">Esta regla permite a los administradores conectarse al nivel de base de datos desde JumpBox.</span><span class="sxs-lookup"><span data-stu-id="ba482-181">This rule lets administrators connect to the database tier from the jumpbox.</span></span>

<span data-ttu-id="ba482-182">Cree las reglas 2 &ndash; 4 con una prioridad más alta que la primera regla para que puedan invalidarla.</span><span class="sxs-lookup"><span data-stu-id="ba482-182">Create rules 2 &ndash; 4 with higher priority than the first rule, so they override it.</span></span>


### <a name="sql-server-always-on-availability-groups"></a><span data-ttu-id="ba482-183">Grupos de disponibilidad AlwaysOn de SQL Server</span><span class="sxs-lookup"><span data-stu-id="ba482-183">SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="ba482-184">Se recomiendan los [grupos de disponibilidad AlwaysOn][sql-alwayson] para alta disponibilidad de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ba482-184">We recommend [Always On Availability Groups][sql-alwayson] for SQL Server high availability.</span></span> <span data-ttu-id="ba482-185">Antes de Windows Server 2016, los grupos de disponibilidad AlwaysOn requerían un controlador de dominio y todos los nodos del grupo de disponibilidad debían estar en el mismo dominio de AD.</span><span class="sxs-lookup"><span data-stu-id="ba482-185">Prior to Windows Server 2016, Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same AD domain.</span></span>

<span data-ttu-id="ba482-186">Otros niveles se conectan a la base de datos a través de una [escucha de grupo de disponibilidad][sql-alwayson-listeners].</span><span class="sxs-lookup"><span data-stu-id="ba482-186">Other tiers connect to the database through an [availability group listener][sql-alwayson-listeners].</span></span> <span data-ttu-id="ba482-187">La escucha permite a un cliente SQL conectarse sin conocer el nombre de la instancia física de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ba482-187">The listener enables a SQL client to connect without knowing the name of the physical instance of SQL Server.</span></span> <span data-ttu-id="ba482-188">Las máquinas virtuales que acceden a la base de datos deben estar unidas al dominio.</span><span class="sxs-lookup"><span data-stu-id="ba482-188">VMs that access the database must be joined to the domain.</span></span> <span data-ttu-id="ba482-189">El cliente (en este caso, otro nivel) utiliza DNS para resolver el nombre de la red virtual de la escucha en direcciones IP.</span><span class="sxs-lookup"><span data-stu-id="ba482-189">The client (in this case, another tier) uses DNS to resolve the listener's virtual network name into IP addresses.</span></span>

<span data-ttu-id="ba482-190">Configure el grupo de disponibilidad AlwaysOn de SQL Server como sigue:</span><span class="sxs-lookup"><span data-stu-id="ba482-190">Configure the SQL Server Always On Availability Group as follows:</span></span>

1. <span data-ttu-id="ba482-191">Cree un clúster de clústeres de conmutación por error de Windows Server (WSFC), un grupo de disponibilidad AlwaysOn de SQL Server y una réplica principal.</span><span class="sxs-lookup"><span data-stu-id="ba482-191">Create a Windows Server Failover Clustering (WSFC) cluster, a SQL Server Always On Availability Group, and a primary replica.</span></span> <span data-ttu-id="ba482-192">Para más información, vea [Introducción a Grupos de disponibilidad AlwaysOn][sql-alwayson-getting-started].</span><span class="sxs-lookup"><span data-stu-id="ba482-192">For more information, see [Getting Started with Always On Availability Groups][sql-alwayson-getting-started].</span></span> 
2. <span data-ttu-id="ba482-193">Cree un equilibrador de carga interno con una dirección IP privada estática.</span><span class="sxs-lookup"><span data-stu-id="ba482-193">Create an internal load balancer with a static private IP address.</span></span>
3. <span data-ttu-id="ba482-194">Cree una escucha de grupo de disponibilidad y asigne el nombre DNS de la escucha a la dirección IP del equilibrador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="ba482-194">Create an availability group listener, and map the listener's DNS name to the IP address of an internal load balancer.</span></span> 
4. <span data-ttu-id="ba482-195">Cree una regla del equilibrador de carga para el puerto de escucha de SQL Server (puerto TCP 1433 de forma predeterminada).</span><span class="sxs-lookup"><span data-stu-id="ba482-195">Create a load balancer rule for the SQL Server listening port (TCP port 1433 by default).</span></span> <span data-ttu-id="ba482-196">La regla del equilibrador de carga debe habilitar la *IP flotante*, también denominada Direct Server Return.</span><span class="sxs-lookup"><span data-stu-id="ba482-196">The load balancer rule must enable *floating IP*, also called Direct Server Return.</span></span> <span data-ttu-id="ba482-197">Esto causa que la máquina virtual responda directamente al cliente, lo que permite establecer una conexión directa con la réplica principal.</span><span class="sxs-lookup"><span data-stu-id="ba482-197">This causes the VM to reply directly to the client, which enables a direct connection to the primary replica.</span></span>
  
   > [!NOTE]
   > <span data-ttu-id="ba482-198">Cuando la IP flotante está habilitada, el número de puerto de front-end debe ser el mismo que el número de puerto de back-end en la regla del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="ba482-198">When floating IP is enabled, the front-end port number must be the same as the back-end port number in the load balancer rule.</span></span>
   > 
   > 

<span data-ttu-id="ba482-199">Cuando un cliente SQL intenta conectarse, el equilibrador de carga enruta la solicitud de conexión a la réplica principal.</span><span class="sxs-lookup"><span data-stu-id="ba482-199">When a SQL client tries to connect, the load balancer routes the connection request to the primary replica.</span></span> <span data-ttu-id="ba482-200">Si se produce una conmutación por error a otra réplica, el equilibrador de carga enruta automáticamente las solicitudes posteriores a una nueva réplica principal.</span><span class="sxs-lookup"><span data-stu-id="ba482-200">If there is a failover to another replica, the load balancer automatically routes subsequent requests to a new primary replica.</span></span> <span data-ttu-id="ba482-201">Para más información, vea [Configuración de un equilibrador de carga para Grupos de disponibilidad AlwaysOn de SQL Server][sql-alwayson-ilb].</span><span class="sxs-lookup"><span data-stu-id="ba482-201">For more information, see [Configure an ILB listener for SQL Server Always On Availability Groups][sql-alwayson-ilb].</span></span>

<span data-ttu-id="ba482-202">Durante una conmutación por error, se cierran las conexiones de cliente existentes.</span><span class="sxs-lookup"><span data-stu-id="ba482-202">During a failover, existing client connections are closed.</span></span> <span data-ttu-id="ba482-203">Una vez completada la conmutación por error, las conexiones nuevas se enrutarán a la nueva réplica principal.</span><span class="sxs-lookup"><span data-stu-id="ba482-203">After the failover completes, new connections will be routed to the new primary replica.</span></span>

<span data-ttu-id="ba482-204">Si la aplicación realiza significativamente más lecturas que escrituras, puede descargar algunas de las consultas de solo lectura en una réplica secundaria.</span><span class="sxs-lookup"><span data-stu-id="ba482-204">If your application makes significantly more reads than writes, you can offload some of the read-only queries to a secondary replica.</span></span> <span data-ttu-id="ba482-205">Vea [Usar un agente de escucha para conectarse a una réplica secundaria de solo lectura (enrutamiento de solo lectura)][sql-alwayson-read-only-routing].</span><span class="sxs-lookup"><span data-stu-id="ba482-205">See [Using a Listener to Connect to a Read-Only Secondary Replica (Read-Only Routing)][sql-alwayson-read-only-routing].</span></span>

<span data-ttu-id="ba482-206">Pruebe la implementación mediante el [forzado de una conmutación por error manual][sql-alwayson-force-failover] del grupo de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="ba482-206">Test your deployment by [forcing a manual failover][sql-alwayson-force-failover] of the availability group.</span></span>

### <a name="jumpbox"></a><span data-ttu-id="ba482-207">JumpBox</span><span class="sxs-lookup"><span data-stu-id="ba482-207">Jumpbox</span></span>

<span data-ttu-id="ba482-208">No permita el acceso RDP desde la red pública de Internet a las máquinas virtuales que ejecutan la carga de trabajo de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ba482-208">Do not allow RDP access from the public Internet to the VMs that run the application workload.</span></span> <span data-ttu-id="ba482-209">En su lugar, todo el acceso RDP a estas máquinas virtuales debe realizarse a través de JumpBox.</span><span class="sxs-lookup"><span data-stu-id="ba482-209">Instead, all RDP access to these VMs must come through the jumpbox.</span></span> <span data-ttu-id="ba482-210">Un administrador inicia sesión en JumpBox y, después, en la otra máquina virtual desde JumpBox.</span><span class="sxs-lookup"><span data-stu-id="ba482-210">An administrator logs into the jumpbox, and then logs into the other VM from the jumpbox.</span></span> <span data-ttu-id="ba482-211">JumpBox permite el tráfico RDP desde Internet, pero solo desde direcciones IP conocidas y seguras.</span><span class="sxs-lookup"><span data-stu-id="ba482-211">The jumpbox allows RDP traffic from the Internet, but only from known, safe IP addresses.</span></span>

<span data-ttu-id="ba482-212">JumpBox tiene unos requisitos de rendimiento mínimos, por lo que puede seleccionar un pequeño tamaño de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-212">The jumpbox has minimal performance requirements, so select a small VM size.</span></span> <span data-ttu-id="ba482-213">Cree una [dirección IP pública] para JumpBox.</span><span class="sxs-lookup"><span data-stu-id="ba482-213">Create a [public IP address] for the jumpbox.</span></span> <span data-ttu-id="ba482-214">Coloque JumpBox en la misma red virtual que las demás máquinas virtuales, pero en una subred de administración independiente.</span><span class="sxs-lookup"><span data-stu-id="ba482-214">Place the jumpbox in the same VNet as the other VMs, but in a separate management subnet.</span></span>

<span data-ttu-id="ba482-215">Para proteger JumpBox, agregue una regla de grupo de seguridad de red que permita las conexiones RDP solo desde un conjunto seguro de direcciones IP públicas.</span><span class="sxs-lookup"><span data-stu-id="ba482-215">To secure the jumpbox, add an NSG rule that allows RDP connections only from a safe set of public IP addresses.</span></span> <span data-ttu-id="ba482-216">Configure el NSG para las demás subredes, a fin de permitir el tráfico RDP de la subred de administración.</span><span class="sxs-lookup"><span data-stu-id="ba482-216">Configure the NSGs for the other subnets to allow RDP traffic from the management subnet.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="ba482-217">Consideraciones sobre escalabilidad</span><span class="sxs-lookup"><span data-stu-id="ba482-217">Scalability considerations</span></span>

<span data-ttu-id="ba482-218">Los [conjuntos de escalado de máquinas virtuales][vmss] permiten implementar y administrar un conjunto de máquinas virtuales idénticas.</span><span class="sxs-lookup"><span data-stu-id="ba482-218">[VM scale sets][vmss] help you to deploy and manage a set of identical VMs.</span></span> <span data-ttu-id="ba482-219">Los conjuntos de escalado admiten el escalado automático en función de las métricas de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="ba482-219">Scale sets support autoscaling based on performance metrics.</span></span> <span data-ttu-id="ba482-220">A medida que aumenta la carga en las máquinas virtuales, se agregan más máquinas virtuales automáticamente al equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="ba482-220">As the load on the VMs increases, additional VMs are automatically added to the load balancer.</span></span> <span data-ttu-id="ba482-221">Considere la posibilidad de usar conjuntos de escalado si necesita escalar horizontalmente las máquinas virtuales de inmediato o si necesita realizar el escalado automático.</span><span class="sxs-lookup"><span data-stu-id="ba482-221">Consider scale sets if you need to quickly scale out VMs, or need to autoscale.</span></span>

<span data-ttu-id="ba482-222">Hay dos maneras básicas de configurar máquinas virtuales implementadas en un conjunto de escalado:</span><span class="sxs-lookup"><span data-stu-id="ba482-222">There are two basic ways to configure VMs deployed in a scale set:</span></span>

- <span data-ttu-id="ba482-223">Use extensiones para configurar la máquina virtual después de aprovisionarla.</span><span class="sxs-lookup"><span data-stu-id="ba482-223">Use extensions to configure the VM after it is provisioned.</span></span> <span data-ttu-id="ba482-224">Con este método, las nuevas instancias de máquina virtual pueden tardar más en iniciarse que una máquina virtual sin extensiones.</span><span class="sxs-lookup"><span data-stu-id="ba482-224">With this approach, new VM instances may take longer to start up than a VM with no extensions.</span></span>

- <span data-ttu-id="ba482-225">Implemente un [disco administrado](/azure/storage/storage-managed-disks-overview) con una imagen de disco personalizada.</span><span class="sxs-lookup"><span data-stu-id="ba482-225">Deploy a [managed disk](/azure/storage/storage-managed-disks-overview) with a custom disk image.</span></span> <span data-ttu-id="ba482-226">Esta opción puede ser más rápida de implementar.</span><span class="sxs-lookup"><span data-stu-id="ba482-226">This option may be quicker to deploy.</span></span> <span data-ttu-id="ba482-227">Sin embargo, requiere mantener la imagen actualizada.</span><span class="sxs-lookup"><span data-stu-id="ba482-227">However, it requires you to keep the image up to date.</span></span>

<span data-ttu-id="ba482-228">Para obtener consideraciones adicionales, consulte [Consideraciones de diseño para conjuntos de escalado][vmss-design].</span><span class="sxs-lookup"><span data-stu-id="ba482-228">For additional considerations, see [Design considerations for scale sets][vmss-design].</span></span>

> [!TIP]
> <span data-ttu-id="ba482-229">Cuando utilice cualquier solución de escalado automático, pruébela con antelación con cargas de trabajo de nivel de producción.</span><span class="sxs-lookup"><span data-stu-id="ba482-229">When using any autoscale solution, test it with production-level workloads well in advance.</span></span>

<span data-ttu-id="ba482-230">Cada suscripción de Azure tiene límites predeterminados establecidos, incluido un número máximo de máquinas virtuales por región.</span><span class="sxs-lookup"><span data-stu-id="ba482-230">Each Azure subscription has default limits in place, including a maximum number of VMs per region.</span></span> <span data-ttu-id="ba482-231">Puede aumentar el límite si rellena una solicitud de soporte técnico.</span><span class="sxs-lookup"><span data-stu-id="ba482-231">You can increase the limit by filing a support request.</span></span> <span data-ttu-id="ba482-232">Para más información, consulte [Límites, cuotas y restricciones de suscripción y servicios de Microsoft Azure][subscription-limits].</span><span class="sxs-lookup"><span data-stu-id="ba482-232">For more information, see [Azure subscription and service limits, quotas, and constraints][subscription-limits].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="ba482-233">Consideraciones sobre disponibilidad</span><span class="sxs-lookup"><span data-stu-id="ba482-233">Availability considerations</span></span>

<span data-ttu-id="ba482-234">Si no va a usar conjuntos de escalado de máquinas virtuales, ponga estas en el mismo nivel en un conjunto de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="ba482-234">If you are not using VM scale sets, put VMs in the same tier into an availability set.</span></span> <span data-ttu-id="ba482-235">Cree al menos dos máquinas virtuales en el conjunto de disponibilidad, para admitir el [SLA de disponibilidad para máquinas virtuales de Azure][vm-sla].</span><span class="sxs-lookup"><span data-stu-id="ba482-235">Create at least two VMs in the availability set to support the [availability SLA for Azure VMs][vm-sla].</span></span> <span data-ttu-id="ba482-236">Para más información, consulte [Administración de la disponibilidad de las máquinas virtuales][availability-set].</span><span class="sxs-lookup"><span data-stu-id="ba482-236">For more information, see [Manage the availability of virtual machines][availability-set].</span></span> 

<span data-ttu-id="ba482-237">El equilibrador de carga usa [sondeos de mantenimiento][health-probes] para supervisar la disponibilidad de las instancias de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-237">The load balancer uses [health probes][health-probes] to monitor the availability of VM instances.</span></span> <span data-ttu-id="ba482-238">Si un sondeo no puede conectar con una instancia durante un período de tiempo de espera, el equilibrador de carga deja de enviar tráfico a esa máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-238">If a probe cannot reach an instance within a timeout period, the load balancer stops sending traffic to that VM.</span></span> <span data-ttu-id="ba482-239">Sin embargo, el equilibrador de carga continuará con el sondeo y, si la máquina virtual vuelve a estar disponible, el equilibrador de carga reanudará el envío del tráfico a esa máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="ba482-239">However, the load balancer will continue to probe, and if the VM becomes available again, the load balancer resumes sending traffic to that VM.</span></span>

<span data-ttu-id="ba482-240">A continuación, se presentan algunas recomendaciones sobre los sondeos de mantenimiento del equilibrador de carga:</span><span class="sxs-lookup"><span data-stu-id="ba482-240">Here are some recommendations on load balancer health probes:</span></span>

* <span data-ttu-id="ba482-241">Los sondeos pueden probar los protocolos HTTP o TCP.</span><span class="sxs-lookup"><span data-stu-id="ba482-241">Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="ba482-242">Si las máquinas virtuales ejecutan un servidor HTTP, cree un sondeo HTTP.</span><span class="sxs-lookup"><span data-stu-id="ba482-242">If your VMs run an HTTP server, create an HTTP probe.</span></span> <span data-ttu-id="ba482-243">De lo contrario, cree un sondeo TCP.</span><span class="sxs-lookup"><span data-stu-id="ba482-243">Otherwise create a TCP probe.</span></span>
* <span data-ttu-id="ba482-244">Para un sondeo HTTP, especifique la ruta de acceso a un punto de conexión HTTP.</span><span class="sxs-lookup"><span data-stu-id="ba482-244">For an HTTP probe, specify the path to an HTTP endpoint.</span></span> <span data-ttu-id="ba482-245">El sondeo comprueba si hay una respuesta HTTP 200 desde esta ruta de acceso.</span><span class="sxs-lookup"><span data-stu-id="ba482-245">The probe checks for an HTTP 200 response from this path.</span></span> <span data-ttu-id="ba482-246">Puede ser la ruta de acceso raíz ("/") o un punto de conexión de supervisión de mantenimiento que implementa alguna lógica personalizada para comprobar el mantenimiento de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ba482-246">This can be the root path ("/"), or a health-monitoring endpoint that implements some custom logic to check the health of the application.</span></span> <span data-ttu-id="ba482-247">El punto de conexión debe permitir solicitudes HTTP anónimas.</span><span class="sxs-lookup"><span data-stu-id="ba482-247">The endpoint must allow anonymous HTTP requests.</span></span>
* <span data-ttu-id="ba482-248">El sondeo se envía desde una [dirección IP conocida][health-probe-ip], 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="ba482-248">The probe is sent from a [known IP address][health-probe-ip], 168.63.129.16.</span></span> <span data-ttu-id="ba482-249">Asegúrese de que no bloquear el tráfico hacia o desde esta dirección IP en las directivas de firewall o en las reglas de grupo de seguridad de red (NSG).</span><span class="sxs-lookup"><span data-stu-id="ba482-249">Make sure you don't block traffic to or from this IP address in any firewall policies or network security group (NSG) rules.</span></span>
* <span data-ttu-id="ba482-250">Use [registros de sondeo de mantenimiento][health-probe-log] para ver el estado de los sondeos de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="ba482-250">Use [health probe logs][health-probe-log] to view the status of the health probes.</span></span> <span data-ttu-id="ba482-251">Habilite el registro en Azure Portal para cada equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="ba482-251">Enable logging in the Azure portal for each load balancer.</span></span> <span data-ttu-id="ba482-252">Los registros se escriben en Azure Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="ba482-252">Logs are written to Azure Blob storage.</span></span> <span data-ttu-id="ba482-253">Los registros muestran cuántas máquinas virtuales del back-end no reciben tráfico de red debido a las respuestas de sondeo con error.</span><span class="sxs-lookup"><span data-stu-id="ba482-253">The logs show how many VMs on the back end are not receiving network traffic due to failed probe responses.</span></span>

<span data-ttu-id="ba482-254">Si necesita más disponibilidad de la que proporciona el [Acuerdo de Nivel de Servicio de Azure para máquinas virtuales][vm-sla], considere la replicación de la aplicación entre dos regiones y use Azure Traffic Manager para la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="ba482-254">If you need higher availability than the [Azure SLA for VMs][vm-sla] provides, consider replication the application across two regions, using Azure Traffic Manager for failover.</span></span> <span data-ttu-id="ba482-255">Para más información, consulte [Aplicación de n niveles para varias regiones para obtener alta disponibilidad][multi-dc].</span><span class="sxs-lookup"><span data-stu-id="ba482-255">For more information, see [Multi-region N-tier application for high availability][multi-dc].</span></span>  

## <a name="security-considerations"></a><span data-ttu-id="ba482-256">Consideraciones sobre la seguridad</span><span class="sxs-lookup"><span data-stu-id="ba482-256">Security considerations</span></span>

<span data-ttu-id="ba482-257">Las redes virtuales son un límite de aislamiento del tráfico de Azure.</span><span class="sxs-lookup"><span data-stu-id="ba482-257">Virtual networks are a traffic isolation boundary in Azure.</span></span> <span data-ttu-id="ba482-258">Las máquinas virtuales de una red virtual no se pueden comunicar directamente con las máquinas virtuales de una red virtual diferente.</span><span class="sxs-lookup"><span data-stu-id="ba482-258">VMs in one VNet cannot communicate directly with VMs in a different VNet.</span></span> <span data-ttu-id="ba482-259">Las máquinas virtuales que se encuentran en la misma red virtual se pueden comunicar entre sí, a menos que se creen [grupos de seguridad de red][nsg] (NSG) para restringir el tráfico.</span><span class="sxs-lookup"><span data-stu-id="ba482-259">VMs within the same VNet can communicate, unless you create [network security groups][nsg] (NSGs) to restrict traffic.</span></span> <span data-ttu-id="ba482-260">Para más información, consulte [Servicios en la nube de Microsoft y seguridad de red][network-security].</span><span class="sxs-lookup"><span data-stu-id="ba482-260">For more information, see [Microsoft cloud services and network security][network-security].</span></span>

<span data-ttu-id="ba482-261">Para el tráfico entrante de Internet, las reglas del equilibrador de carga definen qué tráfico puede alcanzar el back-end.</span><span class="sxs-lookup"><span data-stu-id="ba482-261">For incoming Internet traffic, the load balancer rules define which traffic can reach the back end.</span></span> <span data-ttu-id="ba482-262">Sin embargo, las reglas del equilibrador de carga no son compatibles con las listas seguras de IP, por lo que si desea agregar determinadas direcciones IP públicas a una lista segura, agregue un NSG a la subred.</span><span class="sxs-lookup"><span data-stu-id="ba482-262">However, load balancer rules don't support IP safe lists, so if you want to add certain public IP addresses to a safe list, add an NSG to the subnet.</span></span>

<span data-ttu-id="ba482-263">Considere la posibilidad de agregar una aplicación virtual de red (NVA) para crear una red perimetral entre la red de Internet y la red virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="ba482-263">Consider adding a network virtual appliance (NVA) to create a DMZ between the Internet and the Azure virtual network.</span></span> <span data-ttu-id="ba482-264">NVA es un término genérico para una aplicación virtual que puede realizar tareas relacionadas con la red, como firewall, inspección de paquetes, auditoría y enrutamiento personalizado.</span><span class="sxs-lookup"><span data-stu-id="ba482-264">NVA is a generic term for a virtual appliance that can perform network-related tasks, such as firewall, packet inspection, auditing, and custom routing.</span></span> <span data-ttu-id="ba482-265">Para más información, vea [Implementación de una red perimetral entre Internet y Azure][dmz].</span><span class="sxs-lookup"><span data-stu-id="ba482-265">For more information, see [Implementing a DMZ between Azure and the Internet][dmz].</span></span>

<span data-ttu-id="ba482-266">Cifre información confidencial en reposo y use [Azure Key Vault][azure-key-vault] para administrar las claves de cifrado de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ba482-266">Encrypt sensitive data at rest and use [Azure Key Vault][azure-key-vault] to manage the database encryption keys.</span></span> <span data-ttu-id="ba482-267">Key Vault puede almacenar las claves de cifrado en módulos de seguridad de hardware (HSM).</span><span class="sxs-lookup"><span data-stu-id="ba482-267">Key Vault can store encryption keys in hardware security modules (HSMs).</span></span> <span data-ttu-id="ba482-268">Para más información, consulte [Configuración de la integración de Azure Key Vault para SQL Server en máquinas virtuales de Azure][sql-keyvault].</span><span class="sxs-lookup"><span data-stu-id="ba482-268">For more information, see [Configure Azure Key Vault Integration for SQL Server on Azure VMs][sql-keyvault].</span></span> <span data-ttu-id="ba482-269">También se recomienda almacenar los secretos de aplicación como, por ejemplo, las cadenas de conexión de base de datos, en Key Vault.</span><span class="sxs-lookup"><span data-stu-id="ba482-269">It's also recommended to store application secrets, such as database connection strings, in Key Vault.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="ba482-270">Implementación de la solución</span><span class="sxs-lookup"><span data-stu-id="ba482-270">Deploy the solution</span></span>

<span data-ttu-id="ba482-271">Hay disponible una implementación de esta arquitectura de referencia en [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="ba482-271">A deployment for this reference architecture is available on [GitHub][github-folder].</span></span> <span data-ttu-id="ba482-272">Tenga en cuenta que toda la implementación puede tardar hasta dos horas, lo que incluye la ejecución de los scripts para configurar AD DS, el clúster de conmutación por error de Windows Server y el grupo de disponibilidad de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ba482-272">Note that the entire deployment can take up to two hours, which includes running the scripts to configure AD DS, the Windows Server failover cluster, and the SQL Server availability group.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="ba482-273">requisitos previos</span><span class="sxs-lookup"><span data-stu-id="ba482-273">Prerequisites</span></span>

1. <span data-ttu-id="ba482-274">Clone, bifurque o descargue el archivo ZIP del repositorio de GitHub de [arquitecturas de referencia][ref-arch-repo].</span><span class="sxs-lookup"><span data-stu-id="ba482-274">Clone, fork, or download the zip file for the [reference architectures][ref-arch-repo] GitHub repository.</span></span>

2. <span data-ttu-id="ba482-275">Instale la [CLI de Azure 2.0][azure-cli-2].</span><span class="sxs-lookup"><span data-stu-id="ba482-275">Install [Azure CLI 2.0][azure-cli-2].</span></span>

3. <span data-ttu-id="ba482-276">Instale el paquete de NPM de [Azure Building Blocks][azbb].</span><span class="sxs-lookup"><span data-stu-id="ba482-276">Install the [Azure building blocks][azbb] npm package.</span></span>

   ```bash
   npm install -g @mspnp/azure-building-blocks
   ```

4. <span data-ttu-id="ba482-277">Desde un símbolo del sistema, un símbolo del sistema de bash o un símbolo del sistema de PowerShell, inicie sesión en la cuenta de Azure mediante el siguiente comando.</span><span class="sxs-lookup"><span data-stu-id="ba482-277">From a command prompt, bash prompt, or PowerShell prompt, login to your Azure account by using the command below.</span></span>

   ```bash
   az login
   ```

### <a name="deploy-the-solution"></a><span data-ttu-id="ba482-278">Implementación de la solución</span><span class="sxs-lookup"><span data-stu-id="ba482-278">Deploy the solution</span></span> 

1. <span data-ttu-id="ba482-279">Ejecute el siguiente comando para crear un grupo de recursos.</span><span class="sxs-lookup"><span data-stu-id="ba482-279">Run the following command to create a resource group.</span></span>

    ```bash
    az group create --location <location> --name <resource-group-name>
    ```

2. <span data-ttu-id="ba482-280">Ejecute el siguiente comando para crear una cuenta de almacenamiento para el testigo en la nube.</span><span class="sxs-lookup"><span data-stu-id="ba482-280">Run the following command to create a Storage account for the Cloud Witness.</span></span>

    ```bash
    az storage account create --location <location> \
      --name <storage-account-name> \
      --resource-group <resource-group-name> \
      --sku Standard_LRS
    ```

3. <span data-ttu-id="ba482-281">Vaya a la carpeta `virtual-machines\n-tier-windows` del repositorio de GitHub de las arquitecturas de referencia.</span><span class="sxs-lookup"><span data-stu-id="ba482-281">Navigate to the `virtual-machines\n-tier-windows` folder of the reference architectures GitHub repository.</span></span>

4. <span data-ttu-id="ba482-282">Abra el archivo `n-tier-windows.json` .</span><span class="sxs-lookup"><span data-stu-id="ba482-282">Open the `n-tier-windows.json` file.</span></span> 

5. <span data-ttu-id="ba482-283">Busque todas las instancias de "witnessStorageBlobEndPoint" y reemplace el texto del marcador de posición por el nombre de la cuenta de almacenamiento del paso 2.</span><span class="sxs-lookup"><span data-stu-id="ba482-283">Search for all instances of "witnessStorageBlobEndPoint" and replace the placeholder text with the name of the Storage account from step 2.</span></span>

    ```json
    "witnessStorageBlobEndPoint": "https://[replace-with-storageaccountname].blob.core.windows.net",
    ```

6. <span data-ttu-id="ba482-284">Ejecute el siguiente comando para mostrar las claves de la cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="ba482-284">Run the following command to list the account keys for the storage account.</span></span>

    ```bash
    az storage account keys list \
      --account-name <storage-account-name> \
      --resource-group <resource-group-name>
    ```

    <span data-ttu-id="ba482-285">La salida debe tener un aspecto similar al siguiente.</span><span class="sxs-lookup"><span data-stu-id="ba482-285">The output should look like the following.</span></span> <span data-ttu-id="ba482-286">Copie el valor de `key1`.</span><span class="sxs-lookup"><span data-stu-id="ba482-286">Copy the value of `key1`.</span></span>

    ```json
    [
    {
        "keyName": "key1",
        "permissions": "Full",
        "value": "..."
    },
    {
        "keyName": "key2",
        "permissions": "Full",
        "value": "..."
    }
    ]
    ```

7. <span data-ttu-id="ba482-287">En el archivo `n-tier-windows.json`, busque todas las instancias de "witnessStorageAccountKey" y pegue la clave de la cuenta.</span><span class="sxs-lookup"><span data-stu-id="ba482-287">In the `n-tier-windows.json` file, search for all instances of "witnessStorageAccountKey" and paste in the account key.</span></span>

    ```json
    "witnessStorageAccountKey": "[replace-with-storagekey]"
    ```

8. <span data-ttu-id="ba482-288">En el archivo `n-tier-windows.json`, busque todas las instancias de `testPassw0rd!23`, `test$!Passw0rd111` y `AweS0me@SQLServicePW`.</span><span class="sxs-lookup"><span data-stu-id="ba482-288">In the `n-tier-windows.json` file, search for all instances `testPassw0rd!23`, `test$!Passw0rd111`, and `AweS0me@SQLServicePW`.</span></span> <span data-ttu-id="ba482-289">Reemplácelas por sus propias contraseñas y guarde el archivo.</span><span class="sxs-lookup"><span data-stu-id="ba482-289">Replace them with your own passwords and save the file.</span></span>

    > [!NOTE]
    > <span data-ttu-id="ba482-290">Si cambia el nombre de usuario del administrador, también debe actualizar los bloques `extensions` en el archivo JSON.</span><span class="sxs-lookup"><span data-stu-id="ba482-290">If you change the adminstrator user name, you must also update the `extensions` blocks in the JSON file.</span></span> 

9. <span data-ttu-id="ba482-291">Ejecute el siguiente comando para implementar la arquitectura.</span><span class="sxs-lookup"><span data-stu-id="ba482-291">Run the following command to deploy the architecture.</span></span>

    ```bash
    azbb -s <your subscription_id> -g <resource_group_name> -l <location> -p n-tier-windows.json --deploy
    ```

<span data-ttu-id="ba482-292">Para obtener más información sobre la implementación de esta arquitectura de referencia de ejemplo mediante Azure Bulding Blocks, visite el [repositorio de GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="ba482-292">For more information on deploying this sample reference architecture using Azure Building Blocks, visit the [GitHub repository][git].</span></span>


<!-- links -->
[dmz]: ../dmz/secure-vnet-dmz.md
[multi-dc]: multi-region-sql-server.md
[n-tier]: n-tier.md
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[azure-administration]: /azure/automation/automation-intro
[azure-availability-sets]: /azure/virtual-machines/virtual-machines-windows-manage-availability#configure-each-application-tier-into-separate-availability-sets
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-cli-2]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest
[azure-dns]: /azure/dns/dns-overview
[azure-key-vault]: https://azure.microsoft.com/services/key-vault
[host bastión]: https://en.wikipedia.org/wiki/Bastion_host
[bastion host]: https://en.wikipedia.org/wiki/Bastion_host
[CIDR]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[cidr]: https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing
[chef]: https://www.chef.io/solutions/azure/
[git]: https://github.com/mspnp/template-building-blocks
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/n-tier-windows
[lb-external-create]: /azure/load-balancer/load-balancer-get-started-internet-portal
[lb-internal-create]: /azure/load-balancer/load-balancer-get-started-ilb-arm-portal
[load-balancer-external]: /azure/load-balancer/load-balancer-internet-overview
[load-balancer-internal]: /azure/load-balancer/load-balancer-internal-overview
[nsg]: /azure/virtual-network/virtual-networks-nsg
[operations-management-suite]: https://www.microsoft.com/server-cloud/operations-management-suite/overview.aspx
[plan-network]: /azure/virtual-network/virtual-network-vnet-plan-design-arm
[private-ip-space]: https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces
[Dirección IP pública]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[public IP address]: /azure/virtual-network/virtual-network-ip-addresses-overview-arm
[puppet]: https://puppetlabs.com/blog/managing-azure-virtual-machines-puppet
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[sql-alwayson]: https://msdn.microsoft.com/library/hh510230.aspx
[sql-alwayson-force-failover]: https://msdn.microsoft.com/library/ff877957.aspx
[sql-alwayson-getting-started]: https://msdn.microsoft.com/library/gg509118.aspx
[sql-alwayson-ilb]: /azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener
[sql-alwayson-listeners]: https://msdn.microsoft.com/library/hh213417.aspx
[sql-alwayson-read-only-routing]: https://technet.microsoft.com/library/hh213417.aspx#ConnectToSecondary
[sql-keyvault]: /azure/virtual-machines/virtual-machines-windows-ps-sql-keyvault
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[vnet faq]: /azure/virtual-network/virtual-networks-faq
[wsfc-whats-new]: https://technet.microsoft.com/windows-server-docs/failover-clustering/whats-new-in-failover-clustering
[Nagios]: https://www.nagios.org/
[Zabbix]: http://www.zabbix.com/
[Icinga]: http://www.icinga.org/
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[0]: ./images/n-tier-sql-server.png "Arquitectura de n niveles con Microsoft Azure"
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview 
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[load-balancer]: /azure/load-balancer/load-balancer-get-started-internet-arm-cli
[load-balancer-hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[subscription-limits]: /azure/azure-subscription-service-limits
[availability-set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[health-probes]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-log]: /azure/load-balancer/load-balancer-monitor-log
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[network-security]: /azure/best-practices-network-security
