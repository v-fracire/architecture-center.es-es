---
title: Estilo de arquitectura CQRS
description: Describe las ventajas, los desafíos y los procedimientos recomendados para las arquitecturas CQRS.
author: MikeWasson
ms.date: 08/30/2018
ms.openlocfilehash: ba7af25f940a01e184279c4665f8fce8ebb71b23
ms.sourcegitcommit: ae8a1de6f4af7a89a66a8339879843d945201f85
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 08/31/2018
ms.locfileid: "43325931"
---
# <a name="cqrs-architecture-style"></a><span data-ttu-id="20d16-103">Estilo de arquitectura CQRS</span><span class="sxs-lookup"><span data-stu-id="20d16-103">CQRS architecture style</span></span>

<span data-ttu-id="20d16-104">La segregación de responsabilidades de consultas y comandos (CQRS) es un estilo de arquitectura que separa las operaciones de lectura de las operaciones de escritura.</span><span class="sxs-lookup"><span data-stu-id="20d16-104">Command and Query Responsibility Segregation (CQRS) is an architecture style that separates read operations from write operations.</span></span> 

![](./images/cqrs-logical.svg)

<span data-ttu-id="20d16-105">En las arquitecturas tradicionales, se utiliza el mismo modelo de datos para consultar y actualizar una base de datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-105">In traditional architectures, the same data model is used to query and update a database.</span></span> <span data-ttu-id="20d16-106">Es sencillo y funciona bien para las operaciones CRUD básicas.</span><span class="sxs-lookup"><span data-stu-id="20d16-106">That's simple and works well for basic CRUD operations.</span></span> <span data-ttu-id="20d16-107">Sin embargo, en aplicaciones más complejas, este enfoque puede resultar difícil de manejar.</span><span class="sxs-lookup"><span data-stu-id="20d16-107">In more complex applications, however, this approach can become unwieldy.</span></span> <span data-ttu-id="20d16-108">Por ejemplo, en el lado de lectura, la aplicación puede realizar muchas consultas diferentes y devolver objetos de transferencia de datos (DTO) con distintas formas.</span><span class="sxs-lookup"><span data-stu-id="20d16-108">For example, on the read side, the application may perform many different queries, returning data transfer objects (DTOs) with different shapes.</span></span> <span data-ttu-id="20d16-109">La asignación de objetos puede llegar a ser algo complicado.</span><span class="sxs-lookup"><span data-stu-id="20d16-109">Object mapping can become complicated.</span></span> <span data-ttu-id="20d16-110">En el lado de escritura, el modelo puede implementar una validación y una lógica de negocios complejas.</span><span class="sxs-lookup"><span data-stu-id="20d16-110">On the write side, the model may implement complex validation and business logic.</span></span> <span data-ttu-id="20d16-111">En consecuencia, puede acabar con un modelo excesivamente complejo que haga demasiado.</span><span class="sxs-lookup"><span data-stu-id="20d16-111">As a result, you can end up with an overly complex model that does too much.</span></span>

<span data-ttu-id="20d16-112">Otro posible problema es que las cargas de trabajo de lectura y escritura suelen ser asimétricas, con requisitos de rendimiento y escalabilidad muy diferentes.</span><span class="sxs-lookup"><span data-stu-id="20d16-112">Another potential problem is that read and write workloads are often asymmetrical, with very different performance and scale requirements.</span></span> 

<span data-ttu-id="20d16-113">CQRS aborda estos problemas mediante la separación de lecturas y escrituras en modelos independientes, con **comandos** para actualizar datos y **consultas** para leer datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-113">CQRS addresses these problems by separating reads and writes into separate models, using **commands** to update data, and **queries** to read data.</span></span>

- <span data-ttu-id="20d16-114">Los comandos deberían basarse en tareas, en lugar de centrarse en datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-114">Commands should be task based, rather than data centric.</span></span> <span data-ttu-id="20d16-115">("Reservar habitación de hotel" y no "Establecer ReservationStatus en Reservado"). Los comandos se pueden colocar en una cola para un procesamiento asincrónico, en lugar de que se procesen de forma sincrónica.</span><span class="sxs-lookup"><span data-stu-id="20d16-115">("Book hotel room," not "set ReservationStatus to Reserved.") Commands may be placed on a queue for asynchronous processing, rather than being processed synchronously.</span></span>

- <span data-ttu-id="20d16-116">Las consultas nunca modifican la base de datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-116">Queries never modify the database.</span></span> <span data-ttu-id="20d16-117">Una consulta devuelve un DTO que no encapsula ningún conocimiento del dominio.</span><span class="sxs-lookup"><span data-stu-id="20d16-117">A query returns a DTO that does not encapsulate any domain knowledge.</span></span>

<span data-ttu-id="20d16-118">Para lograr un mayor aislamiento, puede separar físicamente los datos de lectura de los datos de escritura.</span><span class="sxs-lookup"><span data-stu-id="20d16-118">For greater isolation, you can physically separate the read data from the write data.</span></span> <span data-ttu-id="20d16-119">En ese caso, la base de datos de lectura puede utilizar su propio esquema de datos que está optimizado para las consultas.</span><span class="sxs-lookup"><span data-stu-id="20d16-119">In that case, the read database can use its own data schema that is optimized for queries.</span></span> <span data-ttu-id="20d16-120">Por ejemplo, puede almacenar una [vista materializada][materialized-view] de los datos para evitar combinaciones complejas o asignaciones del asignador relacional de objetos complejas.</span><span class="sxs-lookup"><span data-stu-id="20d16-120">For example, it can store a [materialized view][materialized-view] of the data, in order to avoid complex joins or complex O/RM mappings.</span></span> <span data-ttu-id="20d16-121">Incluso puede usar un tipo de almacén de datos diferente.</span><span class="sxs-lookup"><span data-stu-id="20d16-121">It might even use a different type of data store.</span></span> <span data-ttu-id="20d16-122">Por ejemplo, la base de datos de escritura puede ser relacional, mientras que la base de datos de lectura es una base de datos de documentos.</span><span class="sxs-lookup"><span data-stu-id="20d16-122">For example, the write database might be relational, while the read database is a document database.</span></span>

<span data-ttu-id="20d16-123">Si se utilizan bases de datos de escritura y de lectura independientes, se deben mantener sincronizados. Normalmente esto se consigue haciendo que el modelo de escritura publique un evento cada vez que actualiza la base de datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-123">If separate read and write databases are used, they must be kept in sync. Typically this is accomplished by  having the write model publish an event whenever it updates the database.</span></span> <span data-ttu-id="20d16-124">La actualización de la base de datos y la publicación del evento deben tener lugar en una sola transacción.</span><span class="sxs-lookup"><span data-stu-id="20d16-124">Updating the database and publishing the event must occur in a single transaction.</span></span> 

<span data-ttu-id="20d16-125">Algunas implementaciones de CQRS utilizan el [patrón Event Sourcing][event-sourcing].</span><span class="sxs-lookup"><span data-stu-id="20d16-125">Some implementations of CQRS use the [Event Sourcing pattern][event-sourcing].</span></span> <span data-ttu-id="20d16-126">Con este patrón, el estado de la aplicación se almacena como una secuencia de eventos.</span><span class="sxs-lookup"><span data-stu-id="20d16-126">With this pattern, application state is stored as a sequence of events.</span></span> <span data-ttu-id="20d16-127">Cada evento representa un conjunto de cambios en los datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-127">Each event represents a set of changes to the data.</span></span> <span data-ttu-id="20d16-128">El estado actual se construye mediante la reproducción de los eventos.</span><span class="sxs-lookup"><span data-stu-id="20d16-128">The current state is constructed by replaying the events.</span></span> <span data-ttu-id="20d16-129">En un contexto de CQRS, una ventaja de Event Sourcing es que se pueden utilizar los mismos eventos para notificar otros componentes, en particular, para notificar el modelo de lectura.</span><span class="sxs-lookup"><span data-stu-id="20d16-129">In a CQRS context, one benefit of Event Sourcing is that the same events can be used to notify other components &mdash; in particular, to notify the read model.</span></span> <span data-ttu-id="20d16-130">El modelo de lectura utiliza los eventos para crear una instantánea del estado actual, que es más eficaz para las consultas.</span><span class="sxs-lookup"><span data-stu-id="20d16-130">The read model uses the events to create a snapshot of the current state, which is more efficient for queries.</span></span> <span data-ttu-id="20d16-131">Sin embargo, Event Sourcing agrega complejidad al diseño.</span><span class="sxs-lookup"><span data-stu-id="20d16-131">However, Event Sourcing adds complexity to the design.</span></span>

![](./images/cqrs-events.svg)

## <a name="when-to-use-this-architecture"></a><span data-ttu-id="20d16-132">Cuándo utilizar esta arquitectura</span><span class="sxs-lookup"><span data-stu-id="20d16-132">When to use this architecture</span></span>

<span data-ttu-id="20d16-133">Considere la posibilidad de utilizar CQRS para los dominios de colaboración en los que varios usuarios tienen acceso a los mismos datos, especialmente cuando las cargas de trabajo de lectura y escritura son asimétricas.</span><span class="sxs-lookup"><span data-stu-id="20d16-133">Consider CQRS for collaborative domains where many users access the same data, especially when the read and write workloads are asymmetrical.</span></span>

<span data-ttu-id="20d16-134">CQRS no es una arquitectura de nivel superior que se aplica a todo un sistema.</span><span class="sxs-lookup"><span data-stu-id="20d16-134">CQRS is not a top-level architecture that applies to an entire system.</span></span> <span data-ttu-id="20d16-135">Aplique CQRS solo a aquellos subsistemas en los que se obtiene un valor evidente de la separación de lecturas y escrituras.</span><span class="sxs-lookup"><span data-stu-id="20d16-135">Apply CQRS only to those subsystems where there is clear value in separating reads and writes.</span></span> <span data-ttu-id="20d16-136">En caso contrario, está creando una complejidad adicional pero sin obtener ventaja alguna.</span><span class="sxs-lookup"><span data-stu-id="20d16-136">Otherwise, you are creating additional complexity for no benefit.</span></span>

## <a name="benefits"></a><span data-ttu-id="20d16-137">Ventajas</span><span class="sxs-lookup"><span data-stu-id="20d16-137">Benefits</span></span>

- <span data-ttu-id="20d16-138">**Escalado de forma independiente**.</span><span class="sxs-lookup"><span data-stu-id="20d16-138">**Independently scaling**.</span></span> <span data-ttu-id="20d16-139">CQRS permite las cargas de trabajo de lectura y escritura que se escalen de forma independiente, lo que puede dar lugar a menos contenciones de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="20d16-139">CQRS allows the read and write workloads to scale independently, and may result in fewer lock contentions.</span></span>
- <span data-ttu-id="20d16-140">**Esquemas de datos optimizados.**</span><span class="sxs-lookup"><span data-stu-id="20d16-140">**Optimized data schemas.**</span></span>  <span data-ttu-id="20d16-141">El lado de lectura puede usar un esquema que está optimizado para las consultas, mientras que el lado de escritura utiliza un esquema que está optimizado para las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="20d16-141">The read side can use a schema that is optimized for queries, while the write side uses a schema that is optimized for updates.</span></span>  
- <span data-ttu-id="20d16-142">**Seguridad**.</span><span class="sxs-lookup"><span data-stu-id="20d16-142">**Security**.</span></span> <span data-ttu-id="20d16-143">Es más fácil asegurarse de que solo las entidades de dominio correctas realicen escrituras en los datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-143">It's easier to ensure that only the right domain entities are performing writes on the data.</span></span>
- <span data-ttu-id="20d16-144">**Separación de cuestiones**.</span><span class="sxs-lookup"><span data-stu-id="20d16-144">**Separation of concerns**.</span></span> <span data-ttu-id="20d16-145">La separación de los lados de lectura y escritura puede dar lugar a modelos que sean más flexibles y fáciles de mantener.</span><span class="sxs-lookup"><span data-stu-id="20d16-145">Segregating the read and write sides can result in models that are more maintainable and flexible.</span></span> <span data-ttu-id="20d16-146">La mayor parte de la lógica de negocios compleja entra en el modelo de escritura.</span><span class="sxs-lookup"><span data-stu-id="20d16-146">Most of the complex business logic goes into the write model.</span></span> <span data-ttu-id="20d16-147">El modelo de lectura puede ser relativamente sencillo.</span><span class="sxs-lookup"><span data-stu-id="20d16-147">The read model can be relatively simple.</span></span>
- <span data-ttu-id="20d16-148">**Consultas más sencillas**.</span><span class="sxs-lookup"><span data-stu-id="20d16-148">**Simpler queries**.</span></span> <span data-ttu-id="20d16-149">Al almacenar una vista materializada en la base de datos de lectura, la aplicación puede evitar combinaciones complejas cuando realiza consultas.</span><span class="sxs-lookup"><span data-stu-id="20d16-149">By storing a materialized view in the read database, the application can avoid complex joins when querying.</span></span>

## <a name="challenges"></a><span data-ttu-id="20d16-150">Desafíos</span><span class="sxs-lookup"><span data-stu-id="20d16-150">Challenges</span></span>

- <span data-ttu-id="20d16-151">**Complejidad**.</span><span class="sxs-lookup"><span data-stu-id="20d16-151">**Complexity**.</span></span> <span data-ttu-id="20d16-152">La idea básica de CQRS es sencilla.</span><span class="sxs-lookup"><span data-stu-id="20d16-152">The basic idea of CQRS is simple.</span></span> <span data-ttu-id="20d16-153">Pero puede generar un diseño de aplicación más complejo, especialmente si incluye el patrón Event Sourcing.</span><span class="sxs-lookup"><span data-stu-id="20d16-153">But it can lead to a more complex application design, especially if they include the Event Sourcing pattern.</span></span>

- <span data-ttu-id="20d16-154">**Mensajería**.</span><span class="sxs-lookup"><span data-stu-id="20d16-154">**Messaging**.</span></span> <span data-ttu-id="20d16-155">Aunque CQRS no requiere mensajería, es normal usarla para procesar comandos y publicar eventos de actualización.</span><span class="sxs-lookup"><span data-stu-id="20d16-155">Although CQRS does not require messaging, it's common to use messaging to process commands and publish update events.</span></span> <span data-ttu-id="20d16-156">En ese caso, la aplicación debe gestionar errores de mensaje o mensajes duplicados.</span><span class="sxs-lookup"><span data-stu-id="20d16-156">In that case, the application must handle message failures or duplicate messages.</span></span> 

- <span data-ttu-id="20d16-157">**Coherencia final**.</span><span class="sxs-lookup"><span data-stu-id="20d16-157">**Eventual consistency**.</span></span> <span data-ttu-id="20d16-158">Si separa las bases de datos de lectura y escritura, los datos de lectura pueden estar obsoletos.</span><span class="sxs-lookup"><span data-stu-id="20d16-158">If you separate the read and write databases, the read data may be stale.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="20d16-159">Procedimientos recomendados</span><span class="sxs-lookup"><span data-stu-id="20d16-159">Best practices</span></span>

- <span data-ttu-id="20d16-160">Para más información acerca de cómo implementar CQRS, consulte [Patrón CQRS][cqrs-pattern].</span><span class="sxs-lookup"><span data-stu-id="20d16-160">For more information about implementing CQRS, see [CQRS Pattern][cqrs-pattern].</span></span>

- <span data-ttu-id="20d16-161">Considere la posibilidad de usar el patrón [Event Sourcing][event-sourcing] para evitar conflictos de actualización.</span><span class="sxs-lookup"><span data-stu-id="20d16-161">Consider using the [Event Sourcing][event-sourcing] pattern to avoid update conflicts.</span></span>

- <span data-ttu-id="20d16-162">Considere la posibilidad de usar el [patrón Materialized View] [materialized-view] para el modelo de lectura y optimizar el esquema para las consultas.</span><span class="sxs-lookup"><span data-stu-id="20d16-162">Consider using the [Materialized View pattern][materialized-view] for the read model, to optimize the schema for queries.</span></span>

## <a name="cqrs-in-microservices"></a><span data-ttu-id="20d16-163">CQRS en microservicios</span><span class="sxs-lookup"><span data-stu-id="20d16-163">CQRS in microservices</span></span>

<span data-ttu-id="20d16-164">CQRS puede ser especialmente útil en una [arquitectura de microservicios][microservices].</span><span class="sxs-lookup"><span data-stu-id="20d16-164">CQRS can be especially useful in a [microservices architecture][microservices].</span></span> <span data-ttu-id="20d16-165">Uno de los principios de los microservicios es que un servicio no tiene acceso directo al almacén de datos de otro servicio.</span><span class="sxs-lookup"><span data-stu-id="20d16-165">One of the principles of microservices is that a service cannot directly access another service's data store.</span></span>

![](./images/cqrs-microservices-wrong.png)

<span data-ttu-id="20d16-166">En el siguiente diagrama, el Servicio A escribe en un almacén de datos y el Servicio B mantiene una vista materializada de los datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-166">In the following diagram, Service A writes to a data store, and Service B keeps a materialized view of the data.</span></span> <span data-ttu-id="20d16-167">El Servicio A publica un evento cada vez que escribe en el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="20d16-167">Service A publishes an event whenever it writes to the data store.</span></span> <span data-ttu-id="20d16-168">El Servicio B se suscribe al evento.</span><span class="sxs-lookup"><span data-stu-id="20d16-168">Service B subscribes to the event.</span></span>

![](./images/cqrs-microservices-right.png)


<!-- links -->

[cqrs-pattern]: ../../patterns/cqrs.md
[event-sourcing]: ../../patterns/event-sourcing.md
[materialized-view]: ../../patterns/materialized-view.md
[microservices]: ./microservices.md
