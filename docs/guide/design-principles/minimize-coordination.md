---
title: Minimizar la coordinación
description: Minimizar la coordinación entre los servicios de aplicación para lograr escalabilidad
author: MikeWasson
ms.date: 08/30/2018
ms.openlocfilehash: 0e0aa34f851ee743a0c4bebc6d9ca63d7f3ae203
ms.sourcegitcommit: ae8a1de6f4af7a89a66a8339879843d945201f85
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 08/31/2018
ms.locfileid: "43326221"
---
# <a name="minimize-coordination"></a><span data-ttu-id="f46f6-103">Minimizar la coordinación</span><span class="sxs-lookup"><span data-stu-id="f46f6-103">Minimize coordination</span></span> 

## <a name="minimize-coordination-between-application-services-to-achieve-scalability"></a><span data-ttu-id="f46f6-104">Minimizar la coordinación entre los servicios de aplicación para lograr escalabilidad</span><span class="sxs-lookup"><span data-stu-id="f46f6-104">Minimize coordination between application services to achieve scalability</span></span>

<span data-ttu-id="f46f6-105">La mayoría de las aplicaciones de nube constan de varios servicios de aplicación &mdash; servidores web front-end, bases de datos, procesos empresariales, informes y análisis, etc.</span><span class="sxs-lookup"><span data-stu-id="f46f6-105">Most cloud applications consist of multiple application services &mdash; web front ends, databases, business processes, reporting and analysis, and so on.</span></span> <span data-ttu-id="f46f6-106">Para lograr escalabilidad y confiabilidad, cada uno de esos servicios debe ejecutarse en varias instancias.</span><span class="sxs-lookup"><span data-stu-id="f46f6-106">To achieve scalability and reliability, each of those services should run on multiple instances.</span></span> 

<span data-ttu-id="f46f6-107">¿Qué sucede cuando dos instancias intentan realizar operaciones simultáneas que afectan a algún estado compartido?</span><span class="sxs-lookup"><span data-stu-id="f46f6-107">What happens when two instances try to perform concurrent operations that affect some shared state?</span></span> <span data-ttu-id="f46f6-108">En algunos casos, debe haber coordinación entre los nodos, por ejemplo, para conservar las garantías ACID.</span><span class="sxs-lookup"><span data-stu-id="f46f6-108">In some cases, there must be coordination across nodes, for example to preserve ACID guarantees.</span></span> <span data-ttu-id="f46f6-109">En este diagrama, `Node2` está esperando a que `Node1` libere un bloqueo de base de datos:</span><span class="sxs-lookup"><span data-stu-id="f46f6-109">In this diagram, `Node2` is waiting for `Node1` to release a database lock:</span></span>

![](./images/database-lock.svg)

<span data-ttu-id="f46f6-110">La coordinación limita las ventajas del escalado horizontal y crea cuellos de botella.</span><span class="sxs-lookup"><span data-stu-id="f46f6-110">Coordination limits the benefits of horizontal scale and creates bottlenecks.</span></span> <span data-ttu-id="f46f6-111">En este ejemplo, a medida que escala horizontalmente la aplicación y agrega más instancias, verá que aumenta la contención de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="f46f6-111">In this example, as you scale out the application and add more instances, you'll see increased lock contention.</span></span> <span data-ttu-id="f46f6-112">En el peor de los casos, las instancias de front-end pasarán la mayor parte del tiempo esperando los bloqueos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-112">In the worst case, the front-end instances will spend most of their time waiting on locks.</span></span>

<span data-ttu-id="f46f6-113">La semántica "exactly once" es otro origen frecuente de coordinación.</span><span class="sxs-lookup"><span data-stu-id="f46f6-113">"Exactly once" semantics are another frequent source of coordination.</span></span> <span data-ttu-id="f46f6-114">Por ejemplo, un pedido debe procesarse exactamente una vez.</span><span class="sxs-lookup"><span data-stu-id="f46f6-114">For example, an order must be processed exactly once.</span></span> <span data-ttu-id="f46f6-115">Dos trabajos escuchan nuevos pedidos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-115">Two workers are listening for new orders.</span></span> <span data-ttu-id="f46f6-116">`Worker1` recoge un pedido para su procesamiento.</span><span class="sxs-lookup"><span data-stu-id="f46f6-116">`Worker1` picks up an order for processing.</span></span> <span data-ttu-id="f46f6-117">La aplicación debe asegurarse no solo de que `Worker2` no duplique el trabajo, sino también de que si `Worker1` se bloquea, no se pierda el pedido.</span><span class="sxs-lookup"><span data-stu-id="f46f6-117">The application must ensure that `Worker2` doesn't duplicate the work, but also if `Worker1` crashes, the order isn't dropped.</span></span>

![](./images/coordination.svg)

<span data-ttu-id="f46f6-118">Aunque puede usar un patrón como [Scheduler Agent Supervisor][sas-pattern] para coordinar los trabajos, en este caso, un enfoque mejor podría ser dividir el trabajo.</span><span class="sxs-lookup"><span data-stu-id="f46f6-118">You can use a pattern such as [Scheduler Agent Supervisor][sas-pattern] to coordinate between the workers, but in this case a better approach might be to partition the work.</span></span> <span data-ttu-id="f46f6-119">Cada trabajo se asigna a un intervalo determinado de pedidos (por ejemplo, por región de facturación).</span><span class="sxs-lookup"><span data-stu-id="f46f6-119">Each worker is assigned a certain range of orders (say, by billing region).</span></span> <span data-ttu-id="f46f6-120">Si se bloquea un trabajo, una nueva instancia lo retoma donde lo dejó la instancia anterior, pero no compiten varias instancias.</span><span class="sxs-lookup"><span data-stu-id="f46f6-120">If a worker crashes, a new instance picks up where the previous instance left off, but multiple instances aren't contending.</span></span>

## <a name="recommendations"></a><span data-ttu-id="f46f6-121">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="f46f6-121">Recommendations</span></span>

<span data-ttu-id="f46f6-122">**Adoptar coherencia definitiva**</span><span class="sxs-lookup"><span data-stu-id="f46f6-122">**Embrace eventual consistency**.</span></span> <span data-ttu-id="f46f6-123">Cuando los datos se distribuyen, hace falta coordinación para exigir fuertes garantías de coherencia.</span><span class="sxs-lookup"><span data-stu-id="f46f6-123">When data is distributed, it takes coordination to enforce strong consistency guarantees.</span></span> <span data-ttu-id="f46f6-124">Por ejemplo, supongamos que una operación actualiza dos bases de datos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-124">For example, suppose an operation updates two databases.</span></span> <span data-ttu-id="f46f6-125">En lugar de colocarla en un único ámbito de transacción, es mejor que el sistema pueda albergar coherencia definitiva, quizás mediante el patrón [Compensating Transaction][compensating-transaction] para realizar la reversión de forma lógica después de un error.</span><span class="sxs-lookup"><span data-stu-id="f46f6-125">Instead of putting it into a single transaction scope, it's better if the system can accommodate eventual consistency, perhaps by using the [Compensating Transaction][compensating-transaction] pattern to logically roll back after a failure.</span></span>

<span data-ttu-id="f46f6-126">**Usar eventos de dominio para sincronizar el estado**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-126">**Use domain events to synchronize state**.</span></span> <span data-ttu-id="f46f6-127">Un [evento de dominio][domain-event] es un evento que se registra cuando sucede algo que tiene importancia dentro del dominio.</span><span class="sxs-lookup"><span data-stu-id="f46f6-127">A [domain event][domain-event] is an event that records when something happens that has significance within the domain.</span></span> <span data-ttu-id="f46f6-128">Los servicios interesados pueden escuchar el evento, en lugar de usar una transacción global para coordinarlo entre varios servicios.</span><span class="sxs-lookup"><span data-stu-id="f46f6-128">Interested services can listen for the event, rather than using a global transaction to coordinate across multiple services.</span></span> <span data-ttu-id="f46f6-129">Si se usa este enfoque, el sistema debe tolerar la coherencia definitiva (consulte el elemento anterior).</span><span class="sxs-lookup"><span data-stu-id="f46f6-129">If this approach is used, the system must tolerate eventual consistency (see previous item).</span></span> 

<span data-ttu-id="f46f6-130">**Considerar patrones como CQRS y Event Sourcing**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-130">**Consider patterns such as CQRS and event sourcing**.</span></span> <span data-ttu-id="f46f6-131">Estos dos patrones pueden ayudar a reducir la contención entre las cargas de trabajo de lectura y escritura.</span><span class="sxs-lookup"><span data-stu-id="f46f6-131">These two patterns can help to reduce contention between read workloads and write workloads.</span></span> 

- <span data-ttu-id="f46f6-132">El [patrón CQRS][cqrs-pattern] separa las operaciones de lectura de las de escritura.</span><span class="sxs-lookup"><span data-stu-id="f46f6-132">The [CQRS pattern][cqrs-pattern] separates read operations from write operations.</span></span> <span data-ttu-id="f46f6-133">En algunas implementaciones, los datos de lectura están separados físicamente de los datos de escritura.</span><span class="sxs-lookup"><span data-stu-id="f46f6-133">In some implementations, the read data is physically separated from the write data.</span></span> 

- <span data-ttu-id="f46f6-134">En el [patrón Event Sourcing][event-sourcing], los cambios de estado se registran como una serie de eventos en un almacén de datos de solo anexión.</span><span class="sxs-lookup"><span data-stu-id="f46f6-134">In the [Event Sourcing pattern][event-sourcing], state changes are recorded as a series of events to an append-only data store.</span></span> <span data-ttu-id="f46f6-135">Anexar un evento al flujo es una operación atómica, que requiere un bloqueo mínimo.</span><span class="sxs-lookup"><span data-stu-id="f46f6-135">Appending an event to the stream is an atomic operation, requiring minimal locking.</span></span> 

<span data-ttu-id="f46f6-136">Estos dos patrones se complementan entre sí.</span><span class="sxs-lookup"><span data-stu-id="f46f6-136">These two patterns complement each other.</span></span> <span data-ttu-id="f46f6-137">Si el almacén de solo escritura en CQRS usa Event Sourcing, el almacén de solo lectura puede escuchar los mismos eventos para crear una instantánea legible del estado actual, optimizada para consultas.</span><span class="sxs-lookup"><span data-stu-id="f46f6-137">If the write-only store in CQRS uses event sourcing, the read-only store can listen for the same events to create a readable snapshot of the current state, optimized for queries.</span></span> <span data-ttu-id="f46f6-138">Sin embargo, antes de adoptar CQRS o Event Sourcing, debe ser consciente de las dificultades de este enfoque.</span><span class="sxs-lookup"><span data-stu-id="f46f6-138">Before adopting CQRS or event sourcing, however, be aware of the challenges of this approach.</span></span> <span data-ttu-id="f46f6-139">Para más información, consulte [CQRS architecture style][cqrs-style] (Estilo de arquitectura CQRS).</span><span class="sxs-lookup"><span data-stu-id="f46f6-139">For more information, see [CQRS architecture style][cqrs-style].</span></span>

<span data-ttu-id="f46f6-140">**Crear particiones de los datos**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-140">**Partition data**.</span></span>  <span data-ttu-id="f46f6-141">Evite colocar todos los datos en un esquema de datos que se comparta entre muchos servicios de aplicación.</span><span class="sxs-lookup"><span data-stu-id="f46f6-141">Avoid putting all of your data into one data schema that is shared across many application services.</span></span> <span data-ttu-id="f46f6-142">En una arquitectura de microservicios se aplica este principio al hacer responsable a cada servicio de su propio almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-142">A microservices architecture enforces this principle by making each service responsible for its own data store.</span></span> <span data-ttu-id="f46f6-143">Dentro de una única base de datos, la creación de particiones de los datos puede mejorar la simultaneidad, dado que un servicio que escriba en una partición no influye en un servicio que escriba en otra.</span><span class="sxs-lookup"><span data-stu-id="f46f6-143">Within a single database, partitioning the data into shards can improve concurrency, because a service writing to one shard does not affect a service writing to a different shard.</span></span>

<span data-ttu-id="f46f6-144">**Diseñar operaciones idempotentes**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-144">**Design idempotent operations**.</span></span> <span data-ttu-id="f46f6-145">Siempre que sea posible, diseñe operaciones que sean idempotentes.</span><span class="sxs-lookup"><span data-stu-id="f46f6-145">When possible, design operations to be idempotent.</span></span> <span data-ttu-id="f46f6-146">De este modo, se pueden administrar mediante la semántica at-least-once.</span><span class="sxs-lookup"><span data-stu-id="f46f6-146">That way, they can be handled using at-least-once semantics.</span></span> <span data-ttu-id="f46f6-147">Por ejemplo, puede colocar los elementos de trabajo en una cola.</span><span class="sxs-lookup"><span data-stu-id="f46f6-147">For example, you can put work items on a queue.</span></span> <span data-ttu-id="f46f6-148">Si se bloquea un trabajo en medio de una operación, otro trabajo recoge simplemente el elemento de trabajo.</span><span class="sxs-lookup"><span data-stu-id="f46f6-148">If a worker crashes in the middle of an operation, another worker simply picks up the work item.</span></span>

<span data-ttu-id="f46f6-149">**Usar el procesamiento paralelo asincrónico**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-149">**Use asynchronous parallel processing**.</span></span> <span data-ttu-id="f46f6-150">Si una operación requiere que varios pasos se realicen de forma asincrónica (por ejemplo, llamadas al servicio remoto), podría llamarlos en paralelo y, a continuación, agregar los resultados.</span><span class="sxs-lookup"><span data-stu-id="f46f6-150">If an operation requires multiple steps that are performed asynchronously (such as remote service calls), you might be able to call them in parallel, and then aggregate the results.</span></span> <span data-ttu-id="f46f6-151">En este enfoque se supone que cada paso no depende de los resultados del paso anterior.</span><span class="sxs-lookup"><span data-stu-id="f46f6-151">This approach assumes that each step does not depend on the results of the previous step.</span></span>   

<span data-ttu-id="f46f6-152">**Usar simultaneidad optimista siempre que sea posible**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-152">**Use optimistic concurrency when possible**.</span></span> <span data-ttu-id="f46f6-153">El control de simultaneidad pesimista usa bloqueos de base de datos para evitar conflictos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-153">Pessimistic concurrency control uses database locks to prevent conflicts.</span></span> <span data-ttu-id="f46f6-154">Esto puede provocar un rendimiento deficiente y reducir la disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="f46f6-154">This can cause poor performance and reduce availability.</span></span> <span data-ttu-id="f46f6-155">Con el control de simultaneidad optimista, cada transacción modifica una copia o instantánea de los datos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-155">With optimistic concurrency control, each transaction modifies a copy or snapshot of the data.</span></span> <span data-ttu-id="f46f6-156">Cuando la transacción se confirma, el motor de base de datos la valida y rechaza las transacciones que podrían afectar a la coherencia de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f46f6-156">When the transaction is committed, the database engine validates the transaction and rejects any transactions that would affect database consistency.</span></span> 

<span data-ttu-id="f46f6-157">Azure SQL Database y SQL Server admiten la simultaneidad optimista gracias al [aislamiento de instantáneas][sql-snapshot-isolation].</span><span class="sxs-lookup"><span data-stu-id="f46f6-157">Azure SQL Database and SQL Server support optimistic concurrency through [snapshot isolation][sql-snapshot-isolation].</span></span> <span data-ttu-id="f46f6-158">Algunos servicios de almacenamiento de Azure admiten la simultaneidad optimista mediante el uso de valores ETag, como [Azure Cosmos DB][cosmosdb-faq] y [Azure Storage][storage-concurrency].</span><span class="sxs-lookup"><span data-stu-id="f46f6-158">Some Azure storage services support optimistic concurrency through the use of Etags, including [Azure Cosmos DB][cosmosdb-faq] and [Azure Storage][storage-concurrency].</span></span>

<span data-ttu-id="f46f6-159">**Considerar MapReduce u otros algoritmos distribuidos paralelos**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-159">**Consider MapReduce or other parallel, distributed algorithms**.</span></span> <span data-ttu-id="f46f6-160">En función de los datos y el tipo de trabajo que se va a realizar, puede que tenga que dividir el trabajo en tareas independientes que puedan realizar varios nodos que funcionan en paralelo.</span><span class="sxs-lookup"><span data-stu-id="f46f6-160">Depending on the data and type of work to be performed, you may be able to split the work into independent tasks that can be performed by multiple nodes working in parallel.</span></span> <span data-ttu-id="f46f6-161">Consulte [Big compute architecture style][big-compute] (Estilo de arquitectura Big Compute).</span><span class="sxs-lookup"><span data-stu-id="f46f6-161">See [Big compute architecture style][big-compute].</span></span>

<span data-ttu-id="f46f6-162">**Usar Leader Election para la coordinación**.</span><span class="sxs-lookup"><span data-stu-id="f46f6-162">**Use leader election for coordination**.</span></span> <span data-ttu-id="f46f6-163">En aquellos casos en los que sea necesario coordinar las operaciones, asegúrese de que el coordinador no se convierta en un único punto de error en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="f46f6-163">In cases where you need to coordinate operations, make sure the coordinator does not become a single point of failure in the application.</span></span> <span data-ttu-id="f46f6-164">Mediante el [patrón Leader Election][leader-election], una instancia es la principal en cualquier momento y actúa como coordinador.</span><span class="sxs-lookup"><span data-stu-id="f46f6-164">Using the [Leader Election pattern][leader-election], one instance is the leader at any time, and acts as the coordinator.</span></span> <span data-ttu-id="f46f6-165">Si en la principal se produce un error, se elige una nueva instancia como principal.</span><span class="sxs-lookup"><span data-stu-id="f46f6-165">If the leader fails, a new instance is elected to be the leader.</span></span> 
 

<!-- links -->

[big-compute]: ../architecture-styles/big-compute.md
[compensating-transaction]: ../../patterns/compensating-transaction.md
[cqrs-style]: ../architecture-styles/cqrs.md
[cqrs-pattern]: ../../patterns/cqrs.md
[cosmosdb-faq]: /azure/cosmos-db/faq
[domain-event]: https://martinfowler.com/eaaDev/DomainEvent.html
[event-sourcing]: ../../patterns/event-sourcing.md
[leader-election]: ../../patterns/leader-election.md
[sas-pattern]: ../../patterns/scheduler-agent-supervisor.md
[sql-snapshot-isolation]: /sql/t-sql/statements/set-transaction-isolation-level-transact-sql
[storage-concurrency]: https://azure.microsoft.com/blog/managing-concurrency-in-microsoft-azure-storage-2/