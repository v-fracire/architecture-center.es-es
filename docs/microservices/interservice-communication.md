---
title: Comunicación entre servicios en los microservicios
description: Comunicación entre servicios en los microservicios
author: MikeWasson
ms.date: 10/23/2018
ms.openlocfilehash: 19a54ffc362a1fc88c3255c9346bd697a319b143
ms.sourcegitcommit: fdcacbfdc77370532a4dde776c5d9b82227dff2d
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/24/2018
ms.locfileid: "49962966"
---
# <a name="designing-microservices-interservice-communication"></a><span data-ttu-id="5fbc6-103">Diseño de microservicios: comunicación entre servicios</span><span class="sxs-lookup"><span data-stu-id="5fbc6-103">Designing microservices: Interservice communication</span></span>

<span data-ttu-id="5fbc6-104">La comunicación entre microservicios tiene que ser eficiente y sólida.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-104">Communication between microservices must be efficient and robust.</span></span> <span data-ttu-id="5fbc6-105">Con una gran cantidad de pequeños servicios interactuando para realizar una sola transacción, esto puede suponer un desafío.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-105">With lots of small services interacting to complete a single transaction, this can be a challenge.</span></span> <span data-ttu-id="5fbc6-106">En este capítulo, veremos los inconvenientes entre la mensajería asincrónica en comparación con las API sincrónicas.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-106">In this chapter, we look at the tradeoffs between asynchronous messaging versus synchronous APIs.</span></span> <span data-ttu-id="5fbc6-107">A continuación, veremos algunos de los desafíos a la hora de diseñar una comunicación resistente entre servicios, y el rol que puede desempeñar una malla de servicio.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-107">Then we look at some of the challenges in designing resilient interservice communication, and the role that a service mesh can play.</span></span>

![](./images/interservice-communication.png)

## <a name="challenges"></a><span data-ttu-id="5fbc6-108">Desafíos</span><span class="sxs-lookup"><span data-stu-id="5fbc6-108">Challenges</span></span> 

<span data-ttu-id="5fbc6-109">Estos son algunos de los principales desafíos que se derivan de la comunicación de servicio a servicio.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-109">Here are some of the main challenges arising from service-to-service communication.</span></span> <span data-ttu-id="5fbc6-110">Las mallas de servicio, que se describe más adelante en este capítulo, están diseñadas para controlar muchos de estos desafíos.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-110">Service meshes, described later in this chapter, are designed to handle many of these challenges.</span></span>

<span data-ttu-id="5fbc6-111">**Resistencia.**</span><span class="sxs-lookup"><span data-stu-id="5fbc6-111">**Resiliency.**</span></span> <span data-ttu-id="5fbc6-112">Puede haber decenas o incluso centenares de instancias de cualquier microservicio concreto.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-112">There may be dozens or even hundreds of instances of any given microservice.</span></span> <span data-ttu-id="5fbc6-113">Se puede producir un error en una instancia por una serie de motivos.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-113">An instance can fail for any number of reasons.</span></span> <span data-ttu-id="5fbc6-114">Puede haber un error de nivel de nodo, como un error de hardware o un reinicio de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-114">There can be a node-level failure, such as a hardware failure or a VM reboot.</span></span> <span data-ttu-id="5fbc6-115">Una instancia puede bloquearse o verse abrumada por las solicitudes, y dejar de procesar todas las nuevas solicitudes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-115">An instance might crash, or be overwhelmed with requests and unable to process any new requests.</span></span> <span data-ttu-id="5fbc6-116">Cualquiera de estos eventos puede provocar que una llamada de red genere un error.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-116">Any of these events can cause a network call to fail.</span></span> <span data-ttu-id="5fbc6-117">Hay dos patrones de diseño que pueden ayudar a que las llamadas de red de servicio a servicio ganen en resistencia:</span><span class="sxs-lookup"><span data-stu-id="5fbc6-117">There are two design patterns that can help make service-to-service network calls more resilient:</span></span>

- <span data-ttu-id="5fbc6-118">**[Retry](../patterns/retry.md)**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-118">**[Retry](../patterns/retry.md)**.</span></span> <span data-ttu-id="5fbc6-119">Una llamada de red puede producir un error debido a un error transitorio que desaparece por sí solo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-119">A network call may fail because of a transient fault that goes away by itself.</span></span> <span data-ttu-id="5fbc6-120">En lugar de declarar un error directamente, el autor de la llamada debería reintentar la operación un determinado número de veces o hasta que transcurra un período de tiempo de espera configurado.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-120">Rather than fail outright, the caller should typically retry the operation a certain number of times, or until a configured time-out period elapses.</span></span> <span data-ttu-id="5fbc6-121">Sin embargo, si una operación no es idempotente, los reintentos pueden producir efectos secundarios no deseados.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-121">However, if an operation is not idempotent, retries can cause unintended side effects.</span></span> <span data-ttu-id="5fbc6-122">La llamada original puede realizarse correctamente, pero el autor de la llamada nunca recibe una respuesta.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-122">The original call might succeed, but the caller never gets a response.</span></span> <span data-ttu-id="5fbc6-123">Si el autor de la llamada vuelve a intentar realizarla, se puede invocar la operación dos veces.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-123">If the caller retries, the operation may be invoked twice.</span></span> <span data-ttu-id="5fbc6-124">Por lo general, no es seguro volver a intentar los métodos POST o PATCH, porque no se garantiza que sean idempotentes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-124">Generally, it's not safe to retry POST or PATCH methods, because these are not guaranteed to be idempotent.</span></span>

- <span data-ttu-id="5fbc6-125">**[Circuit Breaker](../patterns/circuit-breaker.md)**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-125">**[Circuit Breaker](../patterns/circuit-breaker.md)**.</span></span> <span data-ttu-id="5fbc6-126">Demasiadas solicitudes con error pueden causar un cuello de botella, ya que las solicitudes pendientes se acumulan en la cola.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-126">Too many failed requests can cause a bottleneck, as pending requests accumulate in the queue.</span></span> <span data-ttu-id="5fbc6-127">Estas solicitudes bloqueadas pueden contener recursos críticos del sistema, tales como la memoria, subprocesos o conexiones de base de datos, entre otros, que pueden causar errores en cascada.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-127">These blocked requests might hold critical system resources such as memory, threads, database connections, and so on, which can cause cascading failures.</span></span> <span data-ttu-id="5fbc6-128">El patrón Circuit Breaker puede evitar que un servicio intente repetidamente una operación que probablemente produzca errores.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-128">The Circuit Breaker pattern can prevent a service from repeatedly trying an operation that is likely to fail.</span></span> 

<span data-ttu-id="5fbc6-129">**Equilibrio de carga**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-129">**Load balancing**.</span></span> <span data-ttu-id="5fbc6-130">Cuando el servicio "A" llama servicio "B", la solicitud tiene que llegar a una instancia en ejecución del servicio "B".</span><span class="sxs-lookup"><span data-stu-id="5fbc6-130">When service "A" calls service "B", the request must reach a running instance of service "B".</span></span> <span data-ttu-id="5fbc6-131">En Kubernetes, el tipo de recurso `Service` proporciona una dirección IP estable para un grupo de pods.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-131">In Kubernetes, the `Service` resource type provides a stable IP address for a group of pods.</span></span> <span data-ttu-id="5fbc6-132">El tráfico de red a la dirección IP del servicio se reenvía a un pod mediante reglas de iptable.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-132">Network traffic to the service's IP address gets forwarded to a pod by means of iptable rules.</span></span> <span data-ttu-id="5fbc6-133">De forma predeterminada, se elige un pod aleatorio.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-133">By default, a random pod is chosen.</span></span> <span data-ttu-id="5fbc6-134">Una malla de servicio (ver abajo) puede proporcionar algoritmos de equilibrio de carga más inteligentes en función de la latencia observada o de otras métricas.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-134">A service mesh (see below) can provide more intelligent load balancing algorithms based on observed latency or other metrics.</span></span>

<span data-ttu-id="5fbc6-135">**Seguimiento distribuido**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-135">**Distributed tracing**.</span></span> <span data-ttu-id="5fbc6-136">Una sola transacción puede abarcar varios servicios.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-136">A single transaction may span multiple services.</span></span> <span data-ttu-id="5fbc6-137">Esto puede dificultar la supervisión del rendimiento general y del estado del sistema.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-137">That can make it hard to monitor the overall performance and health of the system.</span></span> <span data-ttu-id="5fbc6-138">Incluso si todos los servicios generan registros y métricas, si no hay una manera de unirlos, son de uso limitado.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-138">Even if every service generates logs and metrics, without some way to tie them together, they are of limited use.</span></span> <span data-ttu-id="5fbc6-139">En el capítulo [Registro y supervisión](./logging-monitoring.md) se habla en más detalle acerca del seguimiento distribuido, pero se menciona aquí como un desafío.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-139">The chapter [Logging and monitoring](./logging-monitoring.md) talks more about distributed tracing, but we mention it here as a challenge.</span></span>

<span data-ttu-id="5fbc6-140">**Versiones del servicio**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-140">**Service versioning**.</span></span> <span data-ttu-id="5fbc6-141">Cuando un equipo implementa una nueva versión de un servicio, tiene que evitar romper otros servicios o clientes externos que dependen de él.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-141">When a team deploys a new version of a service, they must avoid breaking any other services or external clients that depend on it.</span></span> <span data-ttu-id="5fbc6-142">Además, puede ejecutar varias versiones de un servicio en paralelo y enrutar las solicitudes a una versión determinada.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-142">In addition, you might want to run multiple versions of a service side-by-side, and route requests to a particular version.</span></span> <span data-ttu-id="5fbc6-143">Consulte [Control de versiones de la API](./api-design.md#api-versioning) para más información sobre este punto.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-143">See [API Versioning](./api-design.md#api-versioning) for more discussion of this issue.</span></span>

<span data-ttu-id="5fbc6-144">**Cifrado TLS y autenticación de TLS mutua**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-144">**TLS encryption and mutual TLS authentication**.</span></span> <span data-ttu-id="5fbc6-145">Por motivos de seguridad, puede querer cifrar el tráfico entre los servicios con TLS y utilizar la autenticación de TLS mutua para autenticar a los autores de las llamadas.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-145">For security reasons, you may want to encrypt traffic between services with TLS, and use mutual TLS authentication to authenticate callers.</span></span>

## <a name="synchronous-versus-asynchronous-messaging"></a><span data-ttu-id="5fbc6-146">Mensajería sincrónica frente a la asincrónica</span><span class="sxs-lookup"><span data-stu-id="5fbc6-146">Synchronous versus asynchronous messaging</span></span>

<span data-ttu-id="5fbc6-147">Hay dos patrones de mensajería básicos que los microservicios pueden usar para comunicarse con otros microservicios.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-147">There are two basic messaging patterns that microservices can use to communicate with other microservices.</span></span> 

1. <span data-ttu-id="5fbc6-148">Comunicación sincrónica.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-148">Synchronous communication.</span></span> <span data-ttu-id="5fbc6-149">En este patrón, un servicio llama a una API que otro servicio expone mediante un protocolo como HTTP o gRPC.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-149">In this pattern, a service calls an API that another service exposes, using a protocol such as HTTP or gRPC.</span></span> <span data-ttu-id="5fbc6-150">Esta opción es un patrón de mensajería sincrónico porque el autor de la llamada espera a la respuesta del receptor.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-150">This option is a synchronous messaging pattern because the caller waits for a response from the receiver.</span></span> 

2. <span data-ttu-id="5fbc6-151">Paso de mensajes asincrónicos.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-151">Asynchronous message passing.</span></span> <span data-ttu-id="5fbc6-152">En este patrón, un servicio envía el mensaje sin esperar por la respuesta, y uno o más servicios procesan el mensaje de forma asincrónica.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-152">In this pattern, a service sends message without waiting for a response, and one or more services process the message asynchronously.</span></span>

<span data-ttu-id="5fbc6-153">Es importante distinguir entre operaciones de E/S asincrónicas y un protocolo asincrónico.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-153">It's important to distinguish between asynchronous I/O and an asynchronous protocol.</span></span> <span data-ttu-id="5fbc6-154">Una operación de E/S asincrónica significa que el subproceso de llamada no se bloquea mientras se completa la E/S.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-154">Asynchronous I/O means the calling thread is not blocked while the I/O completes.</span></span> <span data-ttu-id="5fbc6-155">Esto es importante para el rendimiento, pero es un detalle de implementación en cuanto a la arquitectura.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-155">That's important for performance, but is an implementation detail in terms of the architecture.</span></span> <span data-ttu-id="5fbc6-156">Un protocolo asincrónico significa que el remitente no espera ninguna respuesta.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-156">An asynchronous protocol means the sender doesn't wait for a response.</span></span> <span data-ttu-id="5fbc6-157">HTTP es un protocolo sincrónico, aunque un cliente HTTP puede utilizar operaciones de E/S asincrónicas cuando envía una solicitud.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-157">HTTP is a synchronous protocol, even though an HTTP client may use asynchronous I/O when it sends a request.</span></span> 

<span data-ttu-id="5fbc6-158">Cada patrón tiene sus inconvenientes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-158">There are tradeoffs to each pattern.</span></span> <span data-ttu-id="5fbc6-159">Solicitud/respuesta es un paradigma conocido, por lo que el diseño de una API puede resultar más natural que diseñar un sistema de mensajería.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-159">Request/response is a well-understood paradigm, so designing an API may feel more natural than designing a messaging system.</span></span> <span data-ttu-id="5fbc6-160">Sin embargo, la mensajería asincrónica tiene algunas ventajas que pueden ser muy útiles en una arquitectura de microservicios:</span><span class="sxs-lookup"><span data-stu-id="5fbc6-160">However, asynchronous messaging has some advantages that can be very useful in a microservices architecture:</span></span>

- <span data-ttu-id="5fbc6-161">**Acoplamiento reducido**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-161">**Reduced coupling**.</span></span> <span data-ttu-id="5fbc6-162">El remitente del mensaje no tiene que conocer al consumidor.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-162">The message sender does not need to know about the consumer.</span></span> 

- <span data-ttu-id="5fbc6-163">**Varios suscriptores**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-163">**Multiple subscribers**.</span></span> <span data-ttu-id="5fbc6-164">Al utilizar un modelo de pub/sub, se pueden suscribir varios consumidores para recibir eventos.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-164">Using a pub/sub model, multiple consumers can subscribe to receive events.</span></span> <span data-ttu-id="5fbc6-165">Consulte [Estilo de arquitectura basada en eventos](/azure/architecture/guide/architecture-styles/event-driven).</span><span class="sxs-lookup"><span data-stu-id="5fbc6-165">See [Event-driven architecture style](/azure/architecture/guide/architecture-styles/event-driven).</span></span>

- <span data-ttu-id="5fbc6-166">**Aislamiento de errores**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-166">**Failure isolation**.</span></span> <span data-ttu-id="5fbc6-167">Si se produce un error en el consumidor, el remitente puede seguir enviando mensajes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-167">If the consumer fails, the sender can still send messages.</span></span> <span data-ttu-id="5fbc6-168">Los mensajes se recogerán cuando el consumidor se recupere.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-168">The messages will be picked up when the consumer recovers.</span></span> <span data-ttu-id="5fbc6-169">Esta capacidad es especialmente útil en una arquitectura de microservicios, dado que cada servicio tiene su propio ciclo de vida.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-169">This ability is especially useful in a microservices architecture, because each service has its own lifecycle.</span></span> <span data-ttu-id="5fbc6-170">Un servicio puede dejar de estar disponible o se puede sustituir por una versión más reciente en un momento dado.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-170">A service could become unavailable or be replaced with a newer version at any given time.</span></span> <span data-ttu-id="5fbc6-171">La mensajería asincrónica puede controlar los tiempos de inactividad intermitentes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-171">Asynchronous messaging can handle intermittent downtime.</span></span> <span data-ttu-id="5fbc6-172">Las API sincrónicas, por otro lado, requieren que el servicio de bajada esté disponible o se producirá un error en la operación.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-172">Synchronous APIs, on the other hand, require the downstream service to be available or the operation fails.</span></span> 
 
- <span data-ttu-id="5fbc6-173">**Capacidad de respuesta**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-173">**Responsiveness**.</span></span> <span data-ttu-id="5fbc6-174">Un servicio ascendente puede responder con mayor rapidez si no espera por los servicios de bajada.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-174">An upstream service can reply faster if it does not wait on downstream services.</span></span> <span data-ttu-id="5fbc6-175">Esto es especialmente útil en una arquitectura de microservicios.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-175">This is especially useful in a microservices architecture.</span></span> <span data-ttu-id="5fbc6-176">Si hay una cadena de dependencias de servicio (servicio A llama a B, que llama a C, y así sucesivamente), la espera de las llamadas sincrónicas puede agregar cantidades inaceptables de latencia.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-176">If there is a chain of service dependencies (service A calls B, which calls C, and so on), waiting on synchronous calls can add unacceptable amounts of latency.</span></span>

- <span data-ttu-id="5fbc6-177">**Redistribución de la carga**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-177">**Load leveling**.</span></span> <span data-ttu-id="5fbc6-178">Una cola puede actuar como un búfer para redistribuir la carga de trabajo con el fin de que los receptores puedan procesar mensajes a su propio ritmo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-178">A queue can act as a buffer to level the workload, so that receivers can process messages at their own rate.</span></span> 

- <span data-ttu-id="5fbc6-179">**Flujos de trabajo**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-179">**Workflows**.</span></span> <span data-ttu-id="5fbc6-180">Las colas pueden usarse para administrar un flujo de trabajo, creando puntos de comprobación del mensaje después de cada paso del flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-180">Queues can be used to manage a workflow, by check-pointing the message after each step in the workflow.</span></span>

<span data-ttu-id="5fbc6-181">Sin embargo, el uso eficaz de la mensajería asincrónica también presenta algunos desafíos.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-181">However, there are also some challenges to using asynchronous messaging effectively.</span></span>

- <span data-ttu-id="5fbc6-182">**Acoplamiento con la infraestructura de mensajería**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-182">**Coupling with the messaging infrastructure**.</span></span> <span data-ttu-id="5fbc6-183">El uso de una infraestructura de mensajería determinada puede producir el acoplamiento rígido con esa infraestructura.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-183">Using a particular messaging infrastructure may cause tight coupling with that infrastructure.</span></span> <span data-ttu-id="5fbc6-184">Esto dificultará el cambio a otra infraestructura de mensajería más adelante.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-184">It will be difficult to switch to another messaging infrastructure later.</span></span>

- <span data-ttu-id="5fbc6-185">**Latencia**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-185">**Latency**.</span></span> <span data-ttu-id="5fbc6-186">La latencia de un extremo a otro para una operación puede ser alta si las colas de mensajes se llenan.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-186">End-to-end latency for an operation may become high if the message queues fill up.</span></span>  

- <span data-ttu-id="5fbc6-187">**Costo**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-187">**Cost**.</span></span> <span data-ttu-id="5fbc6-188">Con un rendimiento elevado, el costo económico de la infraestructura de mensajería puede ser significativo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-188">At high throughputs, the monetary cost of the messaging infrastructure could be significant.</span></span>

- <span data-ttu-id="5fbc6-189">**Complejidad**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-189">**Complexity**.</span></span> <span data-ttu-id="5fbc6-190">El control de mensajería asincrónica no es una tarea trivial.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-190">Handling asynchronous messaging is not a trivial task.</span></span> <span data-ttu-id="5fbc6-191">Por ejemplo, tiene que controlar los mensajes duplicados, mediante la desduplicación o haciendo que las operaciones sean idempotentes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-191">For example, you must handle duplicated messages, either by de-duplicating or by making operations idempotent.</span></span> <span data-ttu-id="5fbc6-192">También es difícil implementar la semántica de solicitud-respuesta usando mensajería asincrónica.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-192">It's also hard to implement request-response semantics using asynchronous messaging.</span></span> <span data-ttu-id="5fbc6-193">Para enviar una respuesta, se necesitan otra cola, además de una forma de correlacionar mensajes de solicitud y respuesta.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-193">To send a response, you need another queue, plus a way to correlate request and response messages.</span></span>

- <span data-ttu-id="5fbc6-194">**Rendimiento**.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-194">**Throughput**.</span></span> <span data-ttu-id="5fbc6-195">Si los mensajes requieren *semántica de cola*, la cola puede convertirse en un cuello de botella en el sistema.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-195">If messages require *queue semantics*, the queue can become a bottleneck in the system.</span></span> <span data-ttu-id="5fbc6-196">Cada mensaje requiere por lo menos una operación de cola y una operación de eliminación de cola.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-196">Each message requires at least one queue operation and one dequeue operation.</span></span> <span data-ttu-id="5fbc6-197">Además, la semántica de cola suele necesitar algún tipo de bloqueo dentro de la infraestructura de mensajería.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-197">Moreover, queue semantics generally require some kind of locking inside the messaging infrastructure.</span></span> <span data-ttu-id="5fbc6-198">Si la cola es un servicio administrado, puede haber latencia adicional porque la cola es externa a la red virtual del clúster.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-198">If the queue is a managed service, there may be additional latency, because the queue is external to the cluster's virtual network.</span></span> <span data-ttu-id="5fbc6-199">Para mitigar estos problemas puede procesar mensajes por lotes, pero esto complica el código.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-199">You can mitigate these issues by batching messages, but that complicates the code.</span></span> <span data-ttu-id="5fbc6-200">Si los mensajes no requieren semántica de cola, es posible que pueda usar un *flujo* de eventos en lugar de una cola.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-200">If the messages don't require queue semantics, you might be able to use an event *stream* instead of a queue.</span></span> <span data-ttu-id="5fbc6-201">Para más información, consulte [Estilo de arquitectura basada en eventos](../guide/architecture-styles/event-driven.md).</span><span class="sxs-lookup"><span data-stu-id="5fbc6-201">For more information, see [Event-driven architectural style](../guide/architecture-styles/event-driven.md).</span></span>  

## <a name="drone-delivery-choosing-the-messaging-patterns"></a><span data-ttu-id="5fbc6-202">Drone Delivery: selección de los patrones de mensajería</span><span class="sxs-lookup"><span data-stu-id="5fbc6-202">Drone Delivery: Choosing the messaging patterns</span></span>

<span data-ttu-id="5fbc6-203">Con estas consideraciones en mente, el equipo de desarrollo ha realizado las siguientes opciones de diseño para la aplicación Drone Delivery</span><span class="sxs-lookup"><span data-stu-id="5fbc6-203">With these considerations in mind, the development team made the following design choices for the Drone Delivery application</span></span>

- <span data-ttu-id="5fbc6-204">El servicio Ingestion expone una API de REST pública que las aplicaciones cliente usan para programar, actualizar o cancelar las entregas.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-204">The Ingestion service exposes a public REST API that client applications use to schedule, update, or cancel deliveries.</span></span>

- <span data-ttu-id="5fbc6-205">El servicio Ingestion usa Event Hubs para enviar mensajes asincrónicos al servicio del Scheduler.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-205">The Ingestion service uses Event Hubs to send asynchronous messages to the Scheduler service.</span></span> <span data-ttu-id="5fbc6-206">Los mensajes asincrónicos son necesarios para implementar la nivelación de carga que se requiere para la ingesta.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-206">Asynchronous messages are necessary to implement the load-leveling that is required for ingestion.</span></span> <span data-ttu-id="5fbc6-207">Para más información sobre cómo interactúan los servicios Ingestion y Scheduler, consulte [Ingesta y flujo de trabajo][ingestion-workflow].</span><span class="sxs-lookup"><span data-stu-id="5fbc6-207">For details on how the Ingestion and Scheduler services interact, see [Ingestion and workflow][ingestion-workflow].</span></span>

- <span data-ttu-id="5fbc6-208">Todos los servicios Account, Delivery, Package, Drone y Third-party Transport exponen las API de REST internas.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-208">The Account, Delivery, Package, Drone, and Third-party Transport services all expose internal REST APIs.</span></span> <span data-ttu-id="5fbc6-209">El servicio Scheduler llama a estas API para llevar a cabo una solicitud de usuario.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-209">The Scheduler service calls these APIs to carry out a user request.</span></span> <span data-ttu-id="5fbc6-210">Una razón para usar las API sincrónicas es que Scheduler necesita obtener una respuesta de cada uno de los servicios de bajada.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-210">One reason to use synchronous APIs is that the Scheduler needs to get a response from each of the downstream services.</span></span> <span data-ttu-id="5fbc6-211">Un error en cualquiera de los servicios de bajada significa un error en la operación completa.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-211">A failure in any of the downstream services means the entire operation failed.</span></span> <span data-ttu-id="5fbc6-212">Sin embargo, un problema potencial es la cantidad de latencia que se introduce a través de una llamada a los servicios back-end.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-212">However, a potential issue is the amount of latency that is introduced by calling the backend services.</span></span> 

- <span data-ttu-id="5fbc6-213">Si cualquier servicio de bajada tiene un error no transitorio, toda la transacción debe marcarse como errónea.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-213">If any downstream service has a non-transient failure, the entire transaction should be marked as failed.</span></span> <span data-ttu-id="5fbc6-214">Para controlar este caso, el servicio Scheduler envía un mensaje asincrónico al Supervisor, para que el Supervisor puede programar transacciones de compensación, como se describe en el capítulo [Ingesta y flujo de trabajo][ingestion-workflow].</span><span class="sxs-lookup"><span data-stu-id="5fbc6-214">To handle this case, the Scheduler service sends an asynchronous message to the Supervisor, so that the Supervisor can schedule compensating transactions, as described in the chapter [Ingestion and workflow][ingestion-workflow].</span></span>   

- <span data-ttu-id="5fbc6-215">El servicio de entrega expone una API pública que los clientes pueden utilizar para obtener el estado de una entrega.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-215">The Delivery service exposes a public API that clients can use to get the status of a delivery.</span></span> <span data-ttu-id="5fbc6-216">En el capítulo [Puertas de enlace de API](./gateway.md), se describe cómo una puerta de enlace de API puede ocultar los servicios subyacentes al cliente, de forma que el cliente no necesita saber qué servicios exponen cada API.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-216">In the chapter [API gateway](./gateway.md), we discuss how an API gateway can hide the underlying services from the client, so the client doesn't need to know which services expose which APIs.</span></span> 

- <span data-ttu-id="5fbc6-217">Mientras un dron está en vuelo, el servicio Drone envía eventos que contienen la ubicación actual del dron y su estado.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-217">While a drone is in flight, the Drone service sends events that contain the drone's current location and status.</span></span> <span data-ttu-id="5fbc6-218">El servicio Delivery escucha a estos eventos para el seguimiento del estado de una entrega.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-218">The Delivery service listens to these events in order to track the status of a delivery.</span></span>

- <span data-ttu-id="5fbc6-219">Cuando el estado de una entrega cambia, el servicio Delivery envía un evento de estado de entrega, como `DeliveryCreated` o `DeliveryCompleted`.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-219">When the status of a delivery changes, the Delivery service sends a delivery status event, such as `DeliveryCreated` or `DeliveryCompleted`.</span></span> <span data-ttu-id="5fbc6-220">Cualquier servicio puede suscribirse a estos eventos.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-220">Any service can subscribe to these events.</span></span> <span data-ttu-id="5fbc6-221">En el diseño actual, el servicio Delivery es el único suscriptor, pero más adelante puede haber otros suscriptores.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-221">In the current design, the Delivery service is the only subscriber, but there might be other subscribers later.</span></span> <span data-ttu-id="5fbc6-222">Por ejemplo, los eventos pueden ir a un servicio de análisis en tiempo real.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-222">For example, the events might go to a real-time analytics service.</span></span> <span data-ttu-id="5fbc6-223">Y dado que Scheduler no tiene que esperar una respuesta, agregar más suscriptores no afecta a la ruta de acceso de flujo de trabajo principal.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-223">And because the Scheduler doesn't have to wait for a response, adding more subscribers doesn't affect the main workflow path.</span></span>

![](./images/drone-communication.png)

<span data-ttu-id="5fbc6-224">Tenga en cuenta que los eventos de estado de entrega se derivan de los eventos de la ubicación de dron.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-224">Notice that delivery status events are derived from drone location events.</span></span> <span data-ttu-id="5fbc6-225">Por ejemplo, cuando un dron llega a una ubicación de entrega y suelta un paquete, el servicio Delivery traduce esto en un evento DeliveryCompleted.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-225">For example, when a drone reaches a delivery location and drops off a package, the Delivery service translates this into a DeliveryCompleted event.</span></span> <span data-ttu-id="5fbc6-226">Este es un ejemplo de pensamiento en términos de modelos de dominio.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-226">This is an example of thinking in terms of domain models.</span></span> <span data-ttu-id="5fbc6-227">Como se describió anteriormente, Drone Management pertenece a un contexto independiente enlazado.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-227">As described earlier, Drone Management belongs in a separate bounded context.</span></span> <span data-ttu-id="5fbc6-228">Los eventos de dron proporcionan la ubicación física de un dron.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-228">The drone events convey the physical location of a drone.</span></span> <span data-ttu-id="5fbc6-229">Los eventos de entrega, por otro lado, representan los cambios en el estado de una entrega, que es una entidad empresarial diferente.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-229">The delivery events, on the other hand, represent changes in the status of a delivery, which is a different business entity.</span></span>

## <a name="using-a-service-mesh"></a><span data-ttu-id="5fbc6-230">Uso de una malla de servicio</span><span class="sxs-lookup"><span data-stu-id="5fbc6-230">Using a service mesh</span></span>

<span data-ttu-id="5fbc6-231">Una *malla de servicio* es una capa de software que controla la comunicación de servicio al servicio.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-231">A *service mesh* is a software layer that handles service-to-service communication.</span></span> <span data-ttu-id="5fbc6-232">Las mallas del servicio están diseñadas para tratar muchos de los problemas enumerados en la sección anterior, y para mover la responsabilidad de estas preocupaciones fuera de los microservicios a una capa compartida.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-232">Service meshes are designed to address many of the concerns listed in the previous section, and to move responsibility for these concerns away from the microservices themselves and into a shared layer.</span></span> <span data-ttu-id="5fbc6-233">La malla del servicio actúa como un proxy que intercepta la comunicación de red entre microservicios en el clúster.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-233">The service mesh acts as a proxy that intercepts network communication between microservices in the cluster.</span></span> 

> [!NOTE]
> <span data-ttu-id="5fbc6-234">La malla de servicio es un ejemplo del [patrón Ambassador](../patterns/ambassador.md) &mdash;, un servicio de aplicación auxiliar que envía solicitudes de red en nombre de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-234">Service mesh is an example of the [Ambassador pattern](../patterns/ambassador.md) &mdash; a helper service that sends network requests on behalf of the application.</span></span> 

<span data-ttu-id="5fbc6-235">En estos momentos, las opciones principales para una malla de servicio en Kubernetes son [linkerd](https://linkerd.io/) y [Istio](https://istio.io/).</span><span class="sxs-lookup"><span data-stu-id="5fbc6-235">Right now, the main options for a service mesh in Kubernetes are [linkerd](https://linkerd.io/) and [Istio](https://istio.io/).</span></span> <span data-ttu-id="5fbc6-236">Estas dos tecnologías están evolucionando rápidamente.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-236">Both of these technologies are evolving rapidly.</span></span> <span data-ttu-id="5fbc6-237">De todas formas, algunas características que tienen en común linkerd y Istio incluyen:</span><span class="sxs-lookup"><span data-stu-id="5fbc6-237">However, some features that both linkerd and Istio have in common include:</span></span> 

- <span data-ttu-id="5fbc6-238">El equilibrio de carga en el nivel de sesión, en función de las latencias observadas o el número de solicitudes pendientes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-238">Load balancing at the session level, based on observed latencies or number of outstanding requests.</span></span> <span data-ttu-id="5fbc6-239">Esto puede mejorar el rendimiento sobre el equilibrio de carga de nivel 4 que proporciona Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-239">This can improve performance over the layer-4 load balancing that is provided by Kubernetes.</span></span> 

- <span data-ttu-id="5fbc6-240">Enrutamiento de nivel 7 basado en la ruta de acceso URL, encabezado de Host, versión de API u otras reglas de nivel de aplicación.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-240">Layer-7 routing based on URL path, Host header, API version, or other application-level rules.</span></span>

- <span data-ttu-id="5fbc6-241">Reintentos de solicitudes con error.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-241">Retry of failed requests.</span></span> <span data-ttu-id="5fbc6-242">Una malla de servicio entiende los códigos de error HTTP y puede volver a intentar automáticamente las solicitudes que han tenido un error.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-242">A service mesh understands HTTP error codes, and can automatically retry failed requests.</span></span> <span data-ttu-id="5fbc6-243">Puede configurar el número máximo de reintentos, junto con un período de tiempo de espera para limitar la latencia máxima.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-243">You can configure that maximum number of retries, along with a timeout period in order to bound the maximum latency.</span></span> 

- <span data-ttu-id="5fbc6-244">Interrupción de circuito.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-244">Circuit breaking.</span></span> <span data-ttu-id="5fbc6-245">Si una instancia produce errores en las solicitudes de forma consistente, la malla de servicio la marcará temporalmente como no disponible.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-245">If an instance consistently fails requests, the service mesh will temporarily mark it as unavailable.</span></span> <span data-ttu-id="5fbc6-246">Tras un período de interrupción, intentará la instancia de nuevo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-246">After a backoff period, it will try the instance again.</span></span> <span data-ttu-id="5fbc6-247">Puede configurar el interruptor de circuito en función de diversos criterios, como el número de errores consecutivos,</span><span class="sxs-lookup"><span data-stu-id="5fbc6-247">You can configure the circuit breaker based on various criteria, such as the number of consecutive failures,</span></span>  

- <span data-ttu-id="5fbc6-248">La malla servicio captura métricas sobre llamadas entre servicios, como el volumen de solicitudes, la latencia, las tasas de error y de éxito y los tamaños de respuesta.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-248">Service mesh captures metrics about interservice calls, such as the request volume, latency, error and success rates, and response sizes.</span></span> <span data-ttu-id="5fbc6-249">La malla de servicio también habilita el seguimiento distribuido mediante la incorporación de información de correlación para cada salto en una solicitud.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-249">The service mesh also enables distributed tracing by adding correlation information for each hop in a request.</span></span>

- <span data-ttu-id="5fbc6-250">Autenticación mutua de TLS para las llamadas de servicio a servicio.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-250">Mutual TLS Authentication for service-to-service calls.</span></span>

<span data-ttu-id="5fbc6-251">¿Necesita una malla de servicio?</span><span class="sxs-lookup"><span data-stu-id="5fbc6-251">Do you need a service mesh?</span></span> <span data-ttu-id="5fbc6-252">El valor que se agrega a un sistema distribuido es ciertamente atractivo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-252">The value they add to a distributed system is certainly compelling.</span></span> <span data-ttu-id="5fbc6-253">Si no dispone de una malla de servicio, debe tener en cuenta cada uno de los retos mencionados al principio del capítulo.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-253">If you don't have a service mesh, you will need to consider each of the challenges mentioned at the beginning of the chapter.</span></span> <span data-ttu-id="5fbc6-254">Puede resolver problemas como reintentos, interruptores de circuito y seguimiento distribuido sin una malla de servicio, pero una malla de servicio mueve estos problemas fuera de los servicios individuales a una capa dedicada.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-254">You can solve problems like retry, circuit breaker, and distributed tracing without a service mesh, but a service mesh moves these concerns out of the individual services and into a dedicated layer.</span></span> <span data-ttu-id="5fbc6-255">Por otro lado, las mallas de servicio son una tecnología relativamente nueva que todavía está en proceso de maduración.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-255">On the other hand, service meshes are a relatively new technology that is still maturing.</span></span> <span data-ttu-id="5fbc6-256">La implementación de una malla de servicio agrega complejidad a la instalación y configuración del clúster.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-256">Deploying a service mesh adds complexity to the setup and configuration of the cluster.</span></span> <span data-ttu-id="5fbc6-257">Puede haber implicaciones de rendimiento, porque las solicitudes se enrutan ahora mediante el proxy de la malla de servicio y porque ahora se ejecutan servicios adicionales en cada nodo del clúster.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-257">There may be performance implications, because requests now get routed through the service mesh proxy, and because extra services are now running on every node in the cluster.</span></span> <span data-ttu-id="5fbc6-258">Antes de implementar una malla de servicio en producción, debe realizar pruebas exhaustivas de rendimiento y carga.</span><span class="sxs-lookup"><span data-stu-id="5fbc6-258">You should do thorough performance and load testing before deploying a service mesh in production.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="5fbc6-259">Diseño de API</span><span class="sxs-lookup"><span data-stu-id="5fbc6-259">API design</span></span>](./api-design.md)

<!-- links -->

[ingestion-workflow]: ./ingestion-workflow.md
