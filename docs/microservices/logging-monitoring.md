---
title: Registro y supervisión en los microservicios
description: Registro y supervisión en los microservicios
author: MikeWasson
ms.date: 10/23/2018
ms.openlocfilehash: 9d385a141edb34b2b0f4badb7dfcaf53baac2666
ms.sourcegitcommit: 1b5411f07d74f0a0680b33c266227d24014ba4d1
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 11/26/2018
ms.locfileid: "52305917"
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="b3896-103">Diseño de microservicios: registro y supervisión</span><span class="sxs-lookup"><span data-stu-id="b3896-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="b3896-104">En las aplicaciones complejas, en algún momento algo puede salir mal.</span><span class="sxs-lookup"><span data-stu-id="b3896-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="b3896-105">En una aplicación de microservicios, necesita realizar un seguimiento de lo que está sucediendo en docenas o incluso centenares de servicios.</span><span class="sxs-lookup"><span data-stu-id="b3896-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="b3896-106">El registro y la supervisión son cruciales para tener una visión holística del sistema.</span><span class="sxs-lookup"><span data-stu-id="b3896-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span> 

![](./images/monitoring.png)

<span data-ttu-id="b3896-107">En una arquitectura de microservicios, puede ser especialmente difícil identificar la causa exacta de los errores o los cuellos de botella de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="b3896-107">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="b3896-108">Una única operación de usuario puede abarcar varios servicios.</span><span class="sxs-lookup"><span data-stu-id="b3896-108">A single user operation might span multiple services.</span></span> <span data-ttu-id="b3896-109">Los servicios pueden experimentar límites de E/S de red dentro del clúster.</span><span class="sxs-lookup"><span data-stu-id="b3896-109">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="b3896-110">Una cadena de llamadas a través de los servicios puede provocar una contrapresión en el sistema, y generar una latencia alta o errores en cascada.</span><span class="sxs-lookup"><span data-stu-id="b3896-110">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="b3896-111">Además, por lo general, no sabe en qué nodo se va a ejecutar un contenedor determinado.</span><span class="sxs-lookup"><span data-stu-id="b3896-111">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="b3896-112">Los contenedores que se encuentran en el mismo nodo pueden competir entre sí por una CPU o una memoria limitada.</span><span class="sxs-lookup"><span data-stu-id="b3896-112">Containers placed on the same node may be competing for limited CPU or memory.</span></span> 

<span data-ttu-id="b3896-113">Para comprender lo que está pasando, debe recopilar la telemetría de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b3896-113">To make sense of what's happening, you must collect telemetry from the application.</span></span>  <span data-ttu-id="b3896-114">Los datos de telemetría se pueden dividir en *registros* y *métricas*.</span><span class="sxs-lookup"><span data-stu-id="b3896-114">Telemetry can be divided into *logs* and *metrics*.</span></span> <span data-ttu-id="b3896-115">[Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview) recopila registros y métricas en toda la plataforma Azure.</span><span class="sxs-lookup"><span data-stu-id="b3896-115">[Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview) collects both logs and metrics across the Azure platform.</span></span>

<span data-ttu-id="b3896-116">Los **registros** son registros de eventos basados en texto que tienen lugar mientras la aplicación está en ejecución.</span><span class="sxs-lookup"><span data-stu-id="b3896-116">**Logs** are text-based records of events that occur while the application is running.</span></span> <span data-ttu-id="b3896-117">Incluyen elementos como registros de aplicación (instrucciones de seguimiento) o registros de servidor web.</span><span class="sxs-lookup"><span data-stu-id="b3896-117">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="b3896-118">Los registros son sobre todo útiles para analizar la causa raíz y los análisis forenses.</span><span class="sxs-lookup"><span data-stu-id="b3896-118">Logs are primarily useful for forensics and root cause analysis.</span></span> 

<span data-ttu-id="b3896-119">Las **métricas** son valores numéricos que se pueden analizar.</span><span class="sxs-lookup"><span data-stu-id="b3896-119">**Metrics** are numerical values that can be analyzed.</span></span> <span data-ttu-id="b3896-120">Puede usarlas para observar el sistema en tiempo real (o casi en tiempo real) o para analizar las tendencias de rendimiento a lo largo del tiempo.</span><span class="sxs-lookup"><span data-stu-id="b3896-120">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="b3896-121">Las métricas se pueden subclasificar además de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="b3896-121">Metrics can be further subcategorized as follows:</span></span>

- <span data-ttu-id="b3896-122">Métricas de **nivel de nodo**, lo que incluye uso de CPU, memoria, red, disco y sistema de archivos.</span><span class="sxs-lookup"><span data-stu-id="b3896-122">**Node-level** metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="b3896-123">Las métricas del sistema le ayudan a comprender la asignación de recursos para cada nodo del clúster y solucionar problemas de valores atípicos.</span><span class="sxs-lookup"><span data-stu-id="b3896-123">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>

- <span data-ttu-id="b3896-124">Métricas de **contenedor**.</span><span class="sxs-lookup"><span data-stu-id="b3896-124">**Container** metrics.</span></span> <span data-ttu-id="b3896-125">Si los servicios se ejecutan en contenedores, debe recopilar las métricas en el nivel de contenedor, no solo en el nivel de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="b3896-125">If services are run inside containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="b3896-126">Puede configurar Azure Monitor para supervisar las cargas de trabajo de contenedor en Azure Kubernetes Service (AKS).</span><span class="sxs-lookup"><span data-stu-id="b3896-126">You can set up Azure Monitor to monitor container workloads in Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="b3896-127">Para más información, consulte [Introducción a Azure Monitor para contenedores](/azure/monitoring/monitoring-container-insights-overview).</span><span class="sxs-lookup"><span data-stu-id="b3896-127">For more information, see [Azure Monitor for containers overview](/azure/monitoring/monitoring-container-insights-overview).</span></span> <span data-ttu-id="b3896-128">Para otros orquestadores de contenedores, use la [solución de supervisión de contenedores de Log Analytics](/azure/log-analytics/log-analytics-containers).</span><span class="sxs-lookup"><span data-stu-id="b3896-128">For other container orchestrators, use the [Container Monitoring solution in Log Analytics](/azure/log-analytics/log-analytics-containers).</span></span>

- <span data-ttu-id="b3896-129">Métricas de **aplicación**.</span><span class="sxs-lookup"><span data-stu-id="b3896-129">**Application** metrics.</span></span> <span data-ttu-id="b3896-130">Aquí se incluyen todas las métricas que sean pertinentes para conocer el comportamiento de un servicio.</span><span class="sxs-lookup"><span data-stu-id="b3896-130">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="b3896-131">Algunos ejemplos son el número de solicitudes HTTP entrantes en cola, la latencia de solicitud o la longitud de cola de mensajes.</span><span class="sxs-lookup"><span data-stu-id="b3896-131">Examples include the number of queued inbound HTTP requests, request latency, or message queue length.</span></span> <span data-ttu-id="b3896-132">Las aplicaciones también pueden crear métricas personalizadas que son específicas del dominio, como el número de transacciones de negocio procesadas por minuto.</span><span class="sxs-lookup"><span data-stu-id="b3896-132">Applications can also create custom metrics that are specific to the domain, such as the number of business transactions processed per minute.</span></span> <span data-ttu-id="b3896-133">Use [Application Insights](/azure/application-insights/app-insights-overview) para habilitar las métricas de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b3896-133">Use [Application Insights](/azure/application-insights/app-insights-overview) to enable application metrics.</span></span> 

- <span data-ttu-id="b3896-134">Métricas de **servicios dependientes**.</span><span class="sxs-lookup"><span data-stu-id="b3896-134">**Dependent service** metrics.</span></span> <span data-ttu-id="b3896-135">Los servicios pueden llamar a servicios o puntos de conexión externos, como servicios PaaS o SaaS administrados.</span><span class="sxs-lookup"><span data-stu-id="b3896-135">Services may call external services or endpoints, such as managed PaaS services or SaaS services.</span></span> <span data-ttu-id="b3896-136">Los servicios de terceros pueden proporcionar o no todas las métricas.</span><span class="sxs-lookup"><span data-stu-id="b3896-136">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="b3896-137">Si no es así, tendrá que depender de sus propias métricas de aplicación para realizar el seguimiento de estadísticas de latencia y tasa de errores.</span><span class="sxs-lookup"><span data-stu-id="b3896-137">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

## <a name="considerations"></a><span data-ttu-id="b3896-138">Consideraciones</span><span class="sxs-lookup"><span data-stu-id="b3896-138">Considerations</span></span>

<span data-ttu-id="b3896-139">En el artículo [Supervisión y diagnóstico](../best-practices/monitoring.md) se describen los procedimientos recomendados generales para supervisar una aplicación.</span><span class="sxs-lookup"><span data-stu-id="b3896-139">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="b3896-140">Estos son algunos puntos en los que hay que pensar en el contexto de una arquitectura de microservicios.</span><span class="sxs-lookup"><span data-stu-id="b3896-140">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="b3896-141">**Configuración y administración**.</span><span class="sxs-lookup"><span data-stu-id="b3896-141">**Configuration and management**.</span></span> <span data-ttu-id="b3896-142">¿Va a utilizar un servicio administrado para el registro y la supervisión o a implementar componentes de registro y supervisión como contenedores dentro del clúster?</span><span class="sxs-lookup"><span data-stu-id="b3896-142">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="b3896-143">Para más información sobre estas opciones, consulte la sección [Opciones de tecnología](#technology-options) siguiente.</span><span class="sxs-lookup"><span data-stu-id="b3896-143">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="b3896-144">**Tasa de ingesta**.</span><span class="sxs-lookup"><span data-stu-id="b3896-144">**Ingestion rate**.</span></span> <span data-ttu-id="b3896-145">¿Cuál es el rendimiento con el que el sistema puede recopilar eventos de telemetría?</span><span class="sxs-lookup"><span data-stu-id="b3896-145">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="b3896-146">¿Qué ocurre si se supera la tasa?</span><span class="sxs-lookup"><span data-stu-id="b3896-146">What happens if that rate is exceeded?</span></span> <span data-ttu-id="b3896-147">Por ejemplo, el sistema puede limitar a los clientes, en cuyo caso se pierden los datos de telemetría o es posible que se reduzcan los datos.</span><span class="sxs-lookup"><span data-stu-id="b3896-147">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="b3896-148">A veces puede mitigar este problema reduciendo la cantidad de datos que se recopilan:</span><span class="sxs-lookup"><span data-stu-id="b3896-148">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

  - <span data-ttu-id="b3896-149">Agregar métricas mediante el cálculo de estadísticas, como la media y la desviación estándar, y enviar estos datos estadísticos al sistema de supervisión.</span><span class="sxs-lookup"><span data-stu-id="b3896-149">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>  

  - <span data-ttu-id="b3896-150">Reducir los datos, es decir, procesar solo un porcentaje de los eventos.</span><span class="sxs-lookup"><span data-stu-id="b3896-150">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>

  - <span data-ttu-id="b3896-151">Procesar por lotes los datos para reducir el número de llamadas de red al servicio de supervisión.</span><span class="sxs-lookup"><span data-stu-id="b3896-151">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="b3896-152">**Costo**.</span><span class="sxs-lookup"><span data-stu-id="b3896-152">**Cost**.</span></span> <span data-ttu-id="b3896-153">El costo de la ingesta y del almacenamiento de datos de telemetría puede ser elevado, especialmente en volúmenes grandes.</span><span class="sxs-lookup"><span data-stu-id="b3896-153">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="b3896-154">En algunos casos podría incluso superar el costo de la ejecución de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b3896-154">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="b3896-155">En ese caso, debe reducir el volumen de telemetría mediante la agregación, la reducción de tamaño o el procesamientos por lotes de los datos, tal como se ha descrito anteriormente.</span><span class="sxs-lookup"><span data-stu-id="b3896-155">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span> 
        
<span data-ttu-id="b3896-156">**Fidelidad de los datos**.</span><span class="sxs-lookup"><span data-stu-id="b3896-156">**Data fidelity**.</span></span> <span data-ttu-id="b3896-157">¿Qué grado de precisión tienen las métricas?</span><span class="sxs-lookup"><span data-stu-id="b3896-157">How accurate are the metrics?</span></span> <span data-ttu-id="b3896-158">Las medias pueden ocultar valores atípicos, especialmente a escala.</span><span class="sxs-lookup"><span data-stu-id="b3896-158">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="b3896-159">Además, si la frecuencia de muestreo es demasiado baja, puede suavizar las fluctuaciones en los datos.</span><span class="sxs-lookup"><span data-stu-id="b3896-159">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="b3896-160">Puede parecer que todas las solicitudes tienen la misma latencia de un extremo a otro cuando, en realidad, una fracción considerable de las solicitudes están tardando mucho más.</span><span class="sxs-lookup"><span data-stu-id="b3896-160">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span> 

<span data-ttu-id="b3896-161">**Latencia**.</span><span class="sxs-lookup"><span data-stu-id="b3896-161">**Latency**.</span></span> <span data-ttu-id="b3896-162">Para habilitar las alertas y la supervisión en tiempo real, los datos de telemetría deben estar disponibles rápidamente.</span><span class="sxs-lookup"><span data-stu-id="b3896-162">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="b3896-163">¿En qué medida los datos que aparecen en el panel de supervisión son "en tiempo real"?</span><span class="sxs-lookup"><span data-stu-id="b3896-163">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="b3896-164">¿Tienen unos pocos segundos de antigüedad?</span><span class="sxs-lookup"><span data-stu-id="b3896-164">A few seconds old?</span></span> <span data-ttu-id="b3896-165">¿Más de un minuto?</span><span class="sxs-lookup"><span data-stu-id="b3896-165">More than a minute?</span></span>

<span data-ttu-id="b3896-166">**Almacenamiento**.</span><span class="sxs-lookup"><span data-stu-id="b3896-166">**Storage.**</span></span> <span data-ttu-id="b3896-167">Para los registros, puede ser más eficaz escribir los eventos de registro en un almacenamiento efímero del clúster y configurar un agente para enviar los archivos de registro a un almacenamiento más persistente.</span><span class="sxs-lookup"><span data-stu-id="b3896-167">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="b3896-168">Los datos se moverán, por último, a un almacenamiento a largo plazo para que estén disponibles para un análisis retrospectivo.</span><span class="sxs-lookup"><span data-stu-id="b3896-168">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="b3896-169">Una arquitectura de microservicios puede generar un gran volumen de datos de telemetría, por lo que el costo del almacenamiento de datos es un punto importante que hay que evaluar.</span><span class="sxs-lookup"><span data-stu-id="b3896-169">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="b3896-170">Tenga también en cuenta cómo va a consultar los datos.</span><span class="sxs-lookup"><span data-stu-id="b3896-170">Also consider how you will query the data.</span></span> 

<span data-ttu-id="b3896-171">**Panel y la visualización**.</span><span class="sxs-lookup"><span data-stu-id="b3896-171">**Dashboard and visualization.**</span></span> <span data-ttu-id="b3896-172">¿Obtiene una vista integral del sistema, a través de todos los servicios, tanto en el clúster como en los servicios externos?</span><span class="sxs-lookup"><span data-stu-id="b3896-172">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="b3896-173">Si está escribiendo datos de telemetría y registros en más de una ubicación, ¿puede el panel mostrarlos todos y correlacionarlos?</span><span class="sxs-lookup"><span data-stu-id="b3896-173">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="b3896-174">El panel de supervisión debe mostrar al menos la siguiente información:</span><span class="sxs-lookup"><span data-stu-id="b3896-174">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="b3896-175">Asignación de recursos globales de capacidad y crecimiento.</span><span class="sxs-lookup"><span data-stu-id="b3896-175">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="b3896-176">Aquí se incluyen el número de contenedores, las métricas del sistema de archivos, la red y la asignación de núcleos.</span><span class="sxs-lookup"><span data-stu-id="b3896-176">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="b3896-177">Métricas de contenedor en correlación en el nivel de servicio.</span><span class="sxs-lookup"><span data-stu-id="b3896-177">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="b3896-178">Métricas del sistema en correlación con contenedores.</span><span class="sxs-lookup"><span data-stu-id="b3896-178">System metrics correlated with containers.</span></span>
- <span data-ttu-id="b3896-179">Errores de servicio y valores atípicos.</span><span class="sxs-lookup"><span data-stu-id="b3896-179">Service errors and outliers.</span></span>
    

## <a name="distributed-tracing"></a><span data-ttu-id="b3896-180">Seguimiento distribuido</span><span class="sxs-lookup"><span data-stu-id="b3896-180">Distributed tracing</span></span>

<span data-ttu-id="b3896-181">Tal como se ha mencionado, uno de los retos en los microservicios es entender el flujo de eventos a través de los servicios.</span><span class="sxs-lookup"><span data-stu-id="b3896-181">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="b3896-182">Una única operación o transacción puede implicar llamadas a varios servicios.</span><span class="sxs-lookup"><span data-stu-id="b3896-182">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="b3896-183">Para reconstruir toda la secuencia de pasos, cada servicio debe propagar un *identificador de correlación* que actúa como identificador único para esa operación.</span><span class="sxs-lookup"><span data-stu-id="b3896-183">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="b3896-184">El identificador de correlación habilita el [seguimiento distribuido](https://microservices.io/patterns/observability/distributed-tracing.html) a través de los servicios.</span><span class="sxs-lookup"><span data-stu-id="b3896-184">The correlation ID enables [distributed tracing](https://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="b3896-185">El primer servicio que recibe una solicitud de cliente debe generar el identificador de correlación.</span><span class="sxs-lookup"><span data-stu-id="b3896-185">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="b3896-186">Si el servicio realiza una llamada HTTP a otro servicio, coloca el identificador de correlación en un encabezado de solicitud.</span><span class="sxs-lookup"><span data-stu-id="b3896-186">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="b3896-187">De forma similar, si el servicio envía un mensaje asincrónico, coloca el identificador de correlación en el mensaje.</span><span class="sxs-lookup"><span data-stu-id="b3896-187">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="b3896-188">Los servicios descendentes siguen propagando el identificador de correlación para que fluya a través de todo el sistema.</span><span class="sxs-lookup"><span data-stu-id="b3896-188">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="b3896-189">Además, todo el código que escribe métricas de aplicación o eventos de registro debe incluir el identificador de correlación.</span><span class="sxs-lookup"><span data-stu-id="b3896-189">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="b3896-190">Cuando se ponen en correlación las llamadas de servicio, puede calcular métricas operativas como la latencia de un extremo a otro para una transacción completa, el número de transacciones correctas por segundo y el porcentaje de transacciones erróneas.</span><span class="sxs-lookup"><span data-stu-id="b3896-190">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="b3896-191">La inclusión de identificadores de correlación en registros de aplicación permite realizar análisis de causa raíz.</span><span class="sxs-lookup"><span data-stu-id="b3896-191">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="b3896-192">Si se produce un error en una operación, puede encontrar las instrucciones de registro para todas las llamadas de servicio que formaban parte de la misma operación.</span><span class="sxs-lookup"><span data-stu-id="b3896-192">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span> 

<span data-ttu-id="b3896-193">Estas son algunas consideraciones al implementar el seguimiento distribuido:</span><span class="sxs-lookup"><span data-stu-id="b3896-193">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="b3896-194">Actualmente no hay ningún encabezado HTTP estándar para identificadores de correlación.</span><span class="sxs-lookup"><span data-stu-id="b3896-194">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="b3896-195">El equipo debe estandarizar un valor de encabezado personalizado.</span><span class="sxs-lookup"><span data-stu-id="b3896-195">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="b3896-196">La decisión depende de su plataforma de registro/supervisión o de la elección de una malla de servicio.</span><span class="sxs-lookup"><span data-stu-id="b3896-196">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="b3896-197">Para mensajes asincrónicos, si su infraestructura de mensajería admite la incorporación de metadatos a los mensajes, debe incluir el identificador de correlación como metadatos.</span><span class="sxs-lookup"><span data-stu-id="b3896-197">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="b3896-198">En caso contrario, inclúyalo como parte del esquema del mensaje.</span><span class="sxs-lookup"><span data-stu-id="b3896-198">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="b3896-199">En lugar de un único identificador opaco, puede enviar un *contexto de correlación* que incluya información más completa, como las relaciones entre el autor de la llamada y el destinatario.</span><span class="sxs-lookup"><span data-stu-id="b3896-199">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span> 

- <span data-ttu-id="b3896-200">El SDK de Azure Application Insights inserta automáticamente el contexto de correlación en encabezados HTTP e incluye el identificador de correlación en los registros de Application Insights.</span><span class="sxs-lookup"><span data-stu-id="b3896-200">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="b3896-201">Si decide usar las características de correlación integradas en Application Insights, es posible que algunos servicios necesiten propagar explícitamente aún los encabezados de correlación, en función de las bibliotecas que se vayan a usar.</span><span class="sxs-lookup"><span data-stu-id="b3896-201">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="b3896-202">Para más información, consulte [Correlación de Telemetría en Application Insights](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="b3896-202">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>
   
- <span data-ttu-id="b3896-203">Si usa Istio o linkerd como malla de servicio, estas tecnologías generan automáticamente encabezados de correlación cuando las llamadas HTTP se enrutan a través de los servidores proxy de mallas de servicio.</span><span class="sxs-lookup"><span data-stu-id="b3896-203">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="b3896-204">Los servicios deben reenviar los encabezados pertinentes.</span><span class="sxs-lookup"><span data-stu-id="b3896-204">Services should forward the relevant headers.</span></span> 

    - <span data-ttu-id="b3896-205">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html) (Seguimiento distribuido de solicitudes)</span><span class="sxs-lookup"><span data-stu-id="b3896-205">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
    
    - <span data-ttu-id="b3896-206">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers) (Encabezados de contexto)</span><span class="sxs-lookup"><span data-stu-id="b3896-206">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>
    
- <span data-ttu-id="b3896-207">Tenga en cuenta cómo va a agregar los registros.</span><span class="sxs-lookup"><span data-stu-id="b3896-207">Consider how you will aggregate logs.</span></span> <span data-ttu-id="b3896-208">Puede que desee estandarizar entre los equipos el modo de incluir los identificadores de correlación en los registros.</span><span class="sxs-lookup"><span data-stu-id="b3896-208">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="b3896-209">Use un formato estructurado o semiestructurado, como JSON, y defina un campo común para contener el identificador de correlación.</span><span class="sxs-lookup"><span data-stu-id="b3896-209">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="b3896-210">Opciones de tecnología</span><span class="sxs-lookup"><span data-stu-id="b3896-210">Technology options</span></span>

<span data-ttu-id="b3896-211">**Application Insights** es un servicio administrado de Azure que ingiere y almacena datos de telemetría y proporciona herramientas para analizar y buscar datos.</span><span class="sxs-lookup"><span data-stu-id="b3896-211">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="b3896-212">Para usar Application Insights, instale un paquete de instrumentación en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="b3896-212">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="b3896-213">Este paquete supervisa la aplicación y envía los datos de telemetría al servicio Application Insights.</span><span class="sxs-lookup"><span data-stu-id="b3896-213">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="b3896-214">También puede extraer datos de telemetría desde el entorno de host.</span><span class="sxs-lookup"><span data-stu-id="b3896-214">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="b3896-215">Application Insights proporciona una correlación y un seguimiento de dependencias integrados.</span><span class="sxs-lookup"><span data-stu-id="b3896-215">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="b3896-216">Le permite realizar un seguimiento de las métricas del sistema, las métricas de la aplicación y las métricas de servicio de Azure, en un mismo lugar.</span><span class="sxs-lookup"><span data-stu-id="b3896-216">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="b3896-217">Tenga en cuenta que Application Insights se ve limitado si la velocidad de datos supera un límite máximo; para más información, consulte [Límites de Application Insights](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="b3896-217">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="b3896-218">Una única operación puede generar varios eventos de telemetría, por lo que si la aplicación experimenta un gran volumen de tráfico, es probable que se vea limitada.</span><span class="sxs-lookup"><span data-stu-id="b3896-218">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="b3896-219">Para mitigar este problema, puede realizar un muestreo para reducir el tráfico de telemetría.</span><span class="sxs-lookup"><span data-stu-id="b3896-219">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="b3896-220">El inconveniente es que las métricas serán menos precisas.</span><span class="sxs-lookup"><span data-stu-id="b3896-220">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="b3896-221">Para más información, consulte [Muestreo en Application Insights](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="b3896-221">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="b3896-222">También puede reducir el volumen de datos mediante la agregación previa de métricas, es decir, calcular valores estadísticos, como la media y la desviación estándar, y enviar esos valores en lugar de la telemetría sin formato.</span><span class="sxs-lookup"><span data-stu-id="b3896-222">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="b3896-223">En la siguiente publicación de blog se describe un enfoque sobre el uso de Application Insights a escala: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/) (Supervisión de Azure y análisis a escala).</span><span class="sxs-lookup"><span data-stu-id="b3896-223">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="b3896-224">Además, asegúrese de que comprende el modelo de precios para Application Insights porque se le cobrará en función del volumen de datos.</span><span class="sxs-lookup"><span data-stu-id="b3896-224">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="b3896-225">Para más información, consulte [Administración de precios y volúmenes de datos de Application Insights](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="b3896-225">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="b3896-226">Si la aplicación genera un gran volumen de telemetría y no desea realizar un muestreo ni una agregación de los datos, es posible que Application Insights no sea la opción adecuada.</span><span class="sxs-lookup"><span data-stu-id="b3896-226">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span> 

<span data-ttu-id="b3896-227">Si Application Insights no satisface sus requisitos, le presentamos algunos enfoques sugeridos que emplean tecnologías de código abierto conocidas.</span><span class="sxs-lookup"><span data-stu-id="b3896-227">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="b3896-228">Para las métricas del sistema y de contenedor, considere la posibilidad de exportar las métricas a una base de datos de serie temporal, como **Prometheus** o **InfluxDB**, que se ejecute en el clúster.</span><span class="sxs-lookup"><span data-stu-id="b3896-228">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="b3896-229">InfluxDB es un sistema basado en la inserción.</span><span class="sxs-lookup"><span data-stu-id="b3896-229">InfluxDB is a push-based system.</span></span> <span data-ttu-id="b3896-230">Un agente tiene que insertar las métricas.</span><span class="sxs-lookup"><span data-stu-id="b3896-230">An agent needs to push the metrics.</span></span> <span data-ttu-id="b3896-231">Puede usar [Heapster][heapster], que es un servicio que recopila métricas de todo el clúster de kubelet, agrega los datos y los inserta en InfluxDB u otra solución de almacenamiento de serie temporal.</span><span class="sxs-lookup"><span data-stu-id="b3896-231">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="b3896-232">Azure Container Service implementa Heapster como parte de la instalación del clúster.</span><span class="sxs-lookup"><span data-stu-id="b3896-232">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="b3896-233">Otra opción es [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), que es un agente para recopilar y notificar métricas.</span><span class="sxs-lookup"><span data-stu-id="b3896-233">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span> 

- <span data-ttu-id="b3896-234">Prometheus es un sistema basado en la extracción.</span><span class="sxs-lookup"><span data-stu-id="b3896-234">Prometheus is a pull-based system.</span></span> <span data-ttu-id="b3896-235">Periódicamente extrae métricas de ubicaciones configuradas.</span><span class="sxs-lookup"><span data-stu-id="b3896-235">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="b3896-236">Prometheus puede extraer métricas generadas por cAdvisor o kube-state-metrics.</span><span class="sxs-lookup"><span data-stu-id="b3896-236">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="b3896-237">[kube-state-metrics][kube-state-metrics] es un servicio que recopila métricas del servidor de API de Kubernetes y las pone a disposición de Prometheus (o un extractor que sea compatible con un punto de conexión de cliente de Prometheus).</span><span class="sxs-lookup"><span data-stu-id="b3896-237">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="b3896-238">Mientras que Heapster agrega las métricas que Kubernetes genera y las reenvía a un receptor, kube-state-metrics genera sus propias métricas y hace que estén disponibles a través de un punto de conexión para la extracción.</span><span class="sxs-lookup"><span data-stu-id="b3896-238">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="b3896-239">Para las métricas del sistema, use [node-exporter](https://github.com/prometheus/node_exporter), que es un exportador de Prometheus para las métricas del sistema.</span><span class="sxs-lookup"><span data-stu-id="b3896-239">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="b3896-240">Prometheus admite datos de punto flotante pero no datos de cadena, por lo que es adecuado para las métricas del sistema pero no para los registros.</span><span class="sxs-lookup"><span data-stu-id="b3896-240">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="b3896-241">Use una herramienta de panel como **Kibana** o **Grafana** para visualizar y supervisar los datos.</span><span class="sxs-lookup"><span data-stu-id="b3896-241">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="b3896-242">También se puede ejecutar el servicio de panel dentro de un contenedor en el clúster.</span><span class="sxs-lookup"><span data-stu-id="b3896-242">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="b3896-243">Para los registros de aplicación, considere la posibilidad de usar **Fluentd** y **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="b3896-243">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="b3896-244">Fluentd es un recopilador de datos de código abierto y Elasticsearch es una base de datos de documentos que está optimizada para actuar como un motor de búsqueda.</span><span class="sxs-lookup"><span data-stu-id="b3896-244">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="b3896-245">Con este enfoque, cada servicio envía registros para `stdout` y `stderr`, y Kubernetes escribe estos flujos en el sistema de archivos local.</span><span class="sxs-lookup"><span data-stu-id="b3896-245">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="b3896-246">Fluentd recopila los registros, opcionalmente los enriquece con metadatos adicionales de Kubernetes y los envía a Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="b3896-246">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="b3896-247">Use Kibana, Grafana u otra herramienta similar a fin de crear un panel para Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="b3896-247">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="b3896-248">Fluentd se ejecuta como un daemonset en el clúster, lo que garantiza que se asigne un pod Fluentd a cada nodo.</span><span class="sxs-lookup"><span data-stu-id="b3896-248">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="b3896-249">Puede configurar Fluentd para recopilar registros de kubelet así como registros de contenedor.</span><span class="sxs-lookup"><span data-stu-id="b3896-249">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="b3896-250">En grandes volúmenes, al escribir registros en el sistema de archivos local, se podría generar un cuello de botella de rendimiento especialmente si se ejecutan varios servicios en el mismo nodo.</span><span class="sxs-lookup"><span data-stu-id="b3896-250">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="b3896-251">Supervise la latencia de disco y el uso del sistema de archivos en producción.</span><span class="sxs-lookup"><span data-stu-id="b3896-251">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="b3896-252">Una ventaja de usar Fluentd con Elasticsearch para los registros es que los servicios no requieren dependencias de bibliotecas adicionales.</span><span class="sxs-lookup"><span data-stu-id="b3896-252">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="b3896-253">Cada servicio se escribe en `stdout` y `stderr`, y Fluentd controla la exportación de los registros a Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="b3896-253">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="b3896-254">Además, los equipos que escriben servicios no necesitan entender cómo se configura la infraestructura de registro.</span><span class="sxs-lookup"><span data-stu-id="b3896-254">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="b3896-255">Uno de los retos consiste en configurar el clúster de Elasticsearch para una implementación de producción, a fin de que se escale para administrar el tráfico.</span><span class="sxs-lookup"><span data-stu-id="b3896-255">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span> 

<span data-ttu-id="b3896-256">Otra opción consiste en enviar registros a Log Analytics de Operations Management Suite (OMS).</span><span class="sxs-lookup"><span data-stu-id="b3896-256">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="b3896-257">El servicio [Log Analytics][log-analytics] recopila datos de registro en un repositorio central y también puede consolidar datos de otros servicios de Azure que usa su aplicación.</span><span class="sxs-lookup"><span data-stu-id="b3896-257">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="b3896-258">Para más información, consulte [Supervisión de un clúster de Azure Container Service con Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="b3896-258">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="b3896-259">Ejemplo: registro con identificadores de correlación</span><span class="sxs-lookup"><span data-stu-id="b3896-259">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="b3896-260">Para ilustrar algunos de los puntos que se describen en este capítulo, se muestra un ejemplo completo sobre cómo el servicio de paquete implementa el registro.</span><span class="sxs-lookup"><span data-stu-id="b3896-260">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="b3896-261">El servicio de paquete está escrito en TypeScript y utiliza la plataforma web [Koa](https://koajs.com/) para Node.js.</span><span class="sxs-lookup"><span data-stu-id="b3896-261">The Package service was written in TypeScript and uses the [Koa](https://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="b3896-262">Hay varias bibliotecas de registro de Node.js para elegir.</span><span class="sxs-lookup"><span data-stu-id="b3896-262">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="b3896-263">Hemos elegido [Winston](https://github.com/winstonjs/winston), una biblioteca de registro conocida que ha cumplido nuestros requisitos de rendimiento cuando la hemos probado.</span><span class="sxs-lookup"><span data-stu-id="b3896-263">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="b3896-264">Para encapsular los detalles de implementación, hemos definido una interfaz `ILogger` abstracta:</span><span class="sxs-lookup"><span data-stu-id="b3896-264">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="b3896-265">Esta es una implementación `ILogger` que incluye la biblioteca Winston.</span><span class="sxs-lookup"><span data-stu-id="b3896-265">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="b3896-266">Toma el identificador de correlación como un parámetro de constructor e inserta el identificador en cada mensaje de registro.</span><span class="sxs-lookup"><span data-stu-id="b3896-266">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span> 

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="b3896-267">El servicio de paquete necesita extraer el identificador de correlación de la solicitud HTTP.</span><span class="sxs-lookup"><span data-stu-id="b3896-267">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="b3896-268">Por ejemplo, si usa linkerd, el identificador de correlación se encuentra en el encabezado `l5d-ctx-trace`.</span><span class="sxs-lookup"><span data-stu-id="b3896-268">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="b3896-269">En Koa, la solicitud HTTP se almacena en un objeto de contexto que pasa a través de la canalización de procesamiento de solicitudes.</span><span class="sxs-lookup"><span data-stu-id="b3896-269">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="b3896-270">Se puede definir una función de middleware para obtener el identificador de correlación del contexto e inicializar el registrador.</span><span class="sxs-lookup"><span data-stu-id="b3896-270">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="b3896-271">(Una función de middleware en Koa es simplemente una función que se ejecuta para cada solicitud).</span><span class="sxs-lookup"><span data-stu-id="b3896-271">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({ 
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="b3896-272">Este middleware invoca una función, `getCorrelationId`, definida por el autor de la llamada para obtener el identificador de correlación.</span><span class="sxs-lookup"><span data-stu-id="b3896-272">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="b3896-273">Después crea una instancia del registrador y lo guarda provisionalmente dentro de `ctx.state`, que es un diccionario de claves y valores que se usa en Koa para pasar información a través de la canalización.</span><span class="sxs-lookup"><span data-stu-id="b3896-273">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span> 

<span data-ttu-id="b3896-274">El middleware del registrador se agrega a la canalización en el inicio:</span><span class="sxs-lookup"><span data-stu-id="b3896-274">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="b3896-275">Una vez que está todo configurado, es muy sencillo agregar instrucciones de registro al código.</span><span class="sxs-lookup"><span data-stu-id="b3896-275">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="b3896-276">Por ejemplo, este es el método que busca un paquete.</span><span class="sxs-lookup"><span data-stu-id="b3896-276">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="b3896-277">Realiza dos llamadas al método `ILogger.info`.</span><span class="sxs-lookup"><span data-stu-id="b3896-277">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="b3896-278">No es necesario incluir el identificador de correlación en las instrucciones de registro, ya que la función de middleware lo realiza automáticamente.</span><span class="sxs-lookup"><span data-stu-id="b3896-278">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="b3896-279">Esto hace que el código de registro sea más limpio y reduce la posibilidad de que un desarrollador olvide incluir el identificador de correlación.</span><span class="sxs-lookup"><span data-stu-id="b3896-279">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="b3896-280">Y dado que todas las instrucciones de registro usan la interfaz `ILogger` abstracta, será fácil reemplazar la implementación del registrador más adelante.</span><span class="sxs-lookup"><span data-stu-id="b3896-280">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="b3896-281">Integración y entrega continuas</span><span class="sxs-lookup"><span data-stu-id="b3896-281">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/
